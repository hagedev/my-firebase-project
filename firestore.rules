/**
 * @fileoverview Firestore Security Rules for AirCafe.
 *
 * Core Philosophy:
 * This ruleset enforces a multi-tenant data model with role-based access control.
 * Users are assigned to tenants, and their roles determine their access rights.
 * Superadmins have unrestricted access, while tenant admins (admin_kafe) are limited to their tenant's data.
 *
 * Data Structure:
 * - /tenants/{tenantId}: Stores tenant-specific data.
 * - /users/{userId}: Stores user profiles and roles, including tenant assignments.
 * - /tenants/{tenantId}/menus/{menuId}: Stores menu items for a specific tenant.
 * - /tenants/{tenantId}/categories/{categoryId}: Stores menu categories for a specific tenant.
 * - /tenants/{tenantId}/orders/{orderId}: Stores orders placed at a specific tenant.
 * - /tenants/{tenantId}/tables/{tableId}: Stores table information for a specific tenant.
 * - /roles_superadmin/{userId}: Used to denote superadmin privileges using DBAC.
 *
 * Key Security Decisions:
 * - Tenant data is isolated using path-based access control.
 * - Superadmin privileges are granted based on the existence of a document in the `/roles_superadmin/{userId}` collection.
 * - Data consistency is enforced by validating the 'tenantId' field in subcollections.
 * - Order creation includes a verification token check for anti-spam.
 *
 * Denormalization for Authorization:
 * - The `tenantId` is duplicated in all subcollections under the `/tenants/{tenantId}` document to enable Authorization Independence.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants read and write access to tenant documents based on role.
     * @path /tenants/{tenantId}
     * @allow (get, list): if true;
     * @allow (create, update, delete): if isAdmin()
     * @deny (get): if false;
     * @deny (list): if false;
     * @deny (create): if !isAdmin();
     * @deny (update): if !isAdmin();
     * @deny (delete): if !isAdmin();
     * @principle Allows superadmins read and write access to tenant data. Public read access is allowed for listing tenants.
     */
    match /tenants/{tenantId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Grants owner-only access to user documents.
     * @path /users/{userId}
     * @allow (get, list): if isOwner(userId)
     * @allow (create): if isSelfCreate(userId);
     * @allow (update, delete): if isExistingOwner(userId)
     * @deny (get): if !isOwner(userId);
     * @deny (list): if !isOwner(userId);
     * @deny (create): if !isSelfCreate(userId);
     * @deny (update): if !isExistingOwner(userId);
     * @deny (delete): if !isExistingOwner(userId);
     * @principle Enforces document ownership for reads and writes.
     */
    match /users/{userId} {
      allow get, list: if isOwner(userId);
      allow create: if isSelfCreate(userId);
      allow update, delete: if isExistingOwner(userId);
    }

    /**
     * @description Grants read and write access to menu items for tenant admins.
     * @path /tenants/{tenantId}/menus/{menuId}
     * @allow (get, list): if true;
     * @allow (create): if isAdminKafe(tenantId) && request.resource.data.tenantId == tenantId;
     * @allow (update, delete): if isAdminKafe(tenantId) && resource.data.tenantId == tenantId && resource != null;
     * @deny (get): if false;
     * @deny (list): if false;
     * @deny (create): if !(isAdminKafe(tenantId) && request.resource.data.tenantId == tenantId);
     * @deny (update): if !(isAdminKafe(tenantId) && resource.data.tenantId == tenantId && resource != null);
     * @deny (delete): if !(isAdminKafe(tenantId) && resource.data.tenantId == tenantId && resource != null);
     * @principle Restricts menu item management to tenant admins.
     */
    match /tenants/{tenantId}/menus/{menuId} {
      allow get, list: if true;
      allow create: if isAdminKafe(tenantId) && request.resource.data.tenantId == tenantId;
      allow update, delete: if isAdminKafe(tenantId) && resource.data.tenantId == tenantId && resource != null;
    }

    /**
     * @description Grants read and write access to menu categories for tenant admins.
     * @path /tenants/{tenantId}/categories/{categoryId}
     * @allow (get, list): if true;
     * @allow (create): if isAdminKafe(tenantId) && request.resource.data.tenantId == tenantId;
     * @allow (update, delete): if isAdminKafe(tenantId) && resource.data.tenantId == tenantId && resource != null;
     * @deny (get): if false;
     * @deny (list): if false;
     * @deny (create): if !(isAdminKafe(tenantId) && request.resource.data.tenantId == tenantId);
     * @deny (update): if !(isAdminKafe(tenantId) && resource.data.tenantId == tenantId && resource != null);
     * @deny (delete): if !(isAdminKafe(tenantId) && resource.data.tenantId == tenantId && resource != null);
     * @principle Restricts menu category management to tenant admins.
     */
    match /tenants/{tenantId}/categories/{categoryId} {
      allow get, list: if true;
      allow create: if isAdminKafe(tenantId) && request.resource.data.tenantId == tenantId;
      allow update, delete: if isAdminKafe(tenantId) && resource.data.tenantId == tenantId && resource != null;
    }

    /**
     * @description Grants read and write access to orders for tenant admins and order creation with verification.
     * @path /tenants/{tenantId}/orders/{orderId}
     * @allow get, list: if isAdminKafe(tenantId);
     * @allow create: if isValidOrder(tenantId);
     * @allow update, delete: if isAdminKafe(tenantId) && resource.data.tenantId == tenantId && resource != null;
     * @deny (get): if !isAdminKafe(tenantId);
     * @deny (list): if !isAdminKafe(tenantId);
     * @deny (create): if !isValidOrder(tenantId);
     * @deny (update): if !(isAdminKafe(tenantId) && resource.data.tenantId == tenantId && resource != null);
     * @deny (delete): if !(isAdminKafe(tenantId) && resource.data.tenantId == tenantId && resource != null);
     * @principle Enforces tenant admin control over orders and validates order creation.
     */
    match /tenants/{tenantId}/orders/{orderId} {
      allow get, list: if isAdminKafe(tenantId);
      allow create: if isValidOrder(tenantId);
      allow update, delete: if isAdminKafe(tenantId) && resource.data.tenantId == tenantId && resource != null;
    }

    /**
     * @description Grants read and write access to tables for tenant admins.
     * @path /tenants/{tenantId}/tables/{tableId}
     * @allow (get, list): if isAdminKafe(tenantId);
     * @allow (create): if isAdminKafe(tenantId) && request.resource.data.tenantId == tenantId;
     * @allow (update, delete): if isAdminKafe(tenantId) && resource.data.tenantId == tenantId && resource != null;
     * @deny (get): if !isAdminKafe(tenantId);
     * @deny (list): if !isAdminKafe(tenantId);
     * @deny (create): if !(isAdminKafe(tenantId) && request.resource.data.tenantId == tenantId);
     * @deny (update): if !(isAdminKafe(tenantId) && resource.data.tenantId == tenantId && resource != null);
     * @deny (delete): if !(isAdminKafe(tenantId) && resource.data.tenantId == tenantId && resource != null);
     * @principle Restricts table management to tenant admins.
     */
    match /tenants/{tenantId}/tables/{tableId} {
      allow get, list: if isAdminKafe(tenantId);
      allow create: if isAdminKafe(tenantId) && request.resource.data.tenantId == tenantId;
      allow update, delete: if isAdminKafe(tenantId) && resource.data.tenantId == tenantId && resource != null;
    }

    /**
     * @description Grants superadmin access based on document existence in this collection.
     * @path /roles_superadmin/{userId}
     * @allow get, list: if isAdmin();
     * @allow create: if isAdmin();
     * @allow update: if false;
     * @allow delete: if isAdmin();
     * @deny (get): if !isAdmin();
     * @deny (list): if !isAdmin();
     * @deny (create): if !isAdmin();
     * @deny (update): if true;
     * @deny (delete): if !isAdmin();
     * @principle Uses DBAC to grant superadmin privileges.
     */
    match /roles_superadmin/{userId} {
       allow get, list, create, delete: if isAdmin();
       allow update: if false;
    }

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    function isSelfCreate(userId) {
      return isSignedIn() && request.auth.uid == userId && request.resource.data.id == userId;
    }

    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_superadmin/$(request.auth.uid));
    }

    function isAdminKafe(tenantId) {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin_kafe'
             && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
    }

    function isValidOrder(tenantId) {
      return isSignedIn() && request.resource.data.tenantId == tenantId
             && request.resource.data.verificationToken == get(/databases/$(database)/documents/tenants/$(tenantId)).data.tokenHarian;
    }
  }
}