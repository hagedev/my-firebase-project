/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a role-based access control system with superadmin and cafe admin roles.
 *
 * Data Structure:
 * - /tenants/{tenantId}: Stores cafe tenant profiles.
 * - /users/{userId}: Stores cafe admin user profiles, linked to a tenant.
 * - /roles_superadmin/{userId}: Stores superadmin role information, keyed by user ID.
 * - /tenants/{tenantId}/menus/{menuId}: Stores menu items for a specific tenant.
 * - /tenants/{tenantId}/categories/{categoryId}: Stores menu categories for a specific tenant.
 * - /tenants/{tenantId}/orders/{orderId}: Stores orders placed at a specific tenant.
 * - /tenants/{tenantId}/tables/{tableId}: Stores tables for a specific tenant.
 *
 * Key Security Decisions:
 * - Superadmin role is checked via the /roles_superadmin collection.
 * - Cafe admins are restricted to their assigned tenant.
 * - All write operations require authentication.
 * - Data validation is minimal in this prototyping phase.
 *
 * Denormalization for Authorization:
 * - The `roles_superadmin` collection denormalizes the superadmin role, enabling fast checks without needing complex queries. The document ID in `roles_superadmin` matches the user's UID.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     * @path N/A (Helper function)
     * @allow N/A (Helper function)
     * @deny N/A (Helper function)
     * @principle Authentication is required for secure access.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user is the owner (userId matches request.auth.uid).
     * @path N/A (Helper function)
     * @allow N/A (Helper function)
     * @deny N/A (Helper function)
     * @principle Enforces user ownership of data.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is an existing owner (isOwner and resource exists).
     * @path N/A (Helper function)
     * @allow N/A (Helper function)
     * @deny N/A (Helper function)
     * @principle Prevents destructive operations on non-existent documents.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the user has the superadmin role.
     * @path N/A (Helper function)
     * @allow N/A (Helper function)
     * @deny N/A (Helper function)
     * @principle Enforces role-based access control.
     */
    function isSuperAdmin() {
      return exists(/databases/$(database)/documents/roles_superadmin/$(request.auth.uid));
    }

    /**
     * @description Allows access to tenant documents.
     * @path /tenants/{tenantId}
     * @allow (get, list) if true (Public Read)
     * @allow (create) if isSignedIn() (Any signed in user can create)
     * @allow (update, delete) if isSuperAdmin() (Superadmin can modify)
     * @deny (create) if false (must be authenticated)
     * @deny (update, delete) if !isSuperAdmin() (only superadmin can modify or delete)
     * @principle Superadmins manage tenants, any logged in user can create.
     */
    match /tenants/{tenantId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if isSuperAdmin() && resource != null;
    }

    /**
     * @description Allows access to user documents.
     * @path /users/{userId}
     * @allow (get, list) if isOwner(userId) or isSuperAdmin()
     * @allow (create) if isOwner(userId) (Self-creation)
     * @allow (update, delete) if isOwner(userId) (Owner-only)
     * @deny (create) if !isOwner(userId)
     * @deny (update, delete) if !isExistingOwner(userId)
     * @principle Enforces user ownership and allows superadmins to view.
     */
    match /users/{userId} {
      allow get, list: if isOwner(userId) || isSuperAdmin();
      allow create: if isOwner(userId);
      allow update, delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows access to superadmin role documents.
     * @path /roles_superadmin/{userId}
     * @allow get: if isSuperAdmin() || isOwner(userId);
     * @allow list: if isSuperAdmin();
     * @allow create: if isSuperAdmin() ;
     * @allow update: if false;
     * @allow delete: if isSuperAdmin() && resource != null;
     * @deny create: if !isSuperAdmin();
     * @deny update: if true;
     * @deny delete: if !isSuperAdmin();
     * @principle Only superadmins can manage superadmin roles.
     */
    match /roles_superadmin/{userId} {
      allow get: if isSuperAdmin() || isOwner(userId);
      allow list: if isSuperAdmin();
      allow create: if isSuperAdmin();
      allow update: if false;
      allow delete: if isSuperAdmin() && resource != null;
    }

    /**
     * @description Allows access to menu documents within a tenant.
     * @path /tenants/{tenantId}/menus/{menuId}
     * @allow get, list: if true; // Public read for menus
     * @allow create: if isSignedIn();
     * @allow update, delete: if isSuperAdmin() && resource != null; // Owner only for write
     * @deny create: if !isSignedIn();
     * @deny update: if !isSuperAdmin() && resource != null;
     * @deny delete: if !isSuperAdmin() && resource != null;
     * @principle Public read, tenant-level admin write.
     */
    match /tenants/{tenantId}/menus/{menuId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if isSuperAdmin() && resource != null;
    }

    /**
     * @description Allows access to category documents within a tenant.
     * @path /tenants/{tenantId}/categories/{categoryId}
     * @allow get, list: if true; // Public read for categories
     * @allow create: if isSignedIn();
     * @allow update, delete: if isSuperAdmin() && resource != null; // Owner only for write
     * @deny create: if !isSignedIn();
     * @deny update: if !isSuperAdmin() && resource != null;
     * @deny delete: if !isSuperAdmin() && resource != null;
     * @principle Public read, tenant-level admin write.
     */
    match /tenants/{tenantId}/categories/{categoryId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if isSuperAdmin() && resource != null;
    }

    /**
     * @description Allows access to order documents within a tenant.
     * @path /tenants/{tenantId}/orders/{orderId}
     * @allow get, list: if true; // Public read for orders
     * @allow create: if isSignedIn();
     * @allow update, delete: if isSuperAdmin() && resource != null; // Owner only for write
     * @deny create: if !isSignedIn();
     * @deny update: if !isSuperAdmin() && resource != null;
     * @deny delete: if !isSuperAdmin() && resource != null;
     * @principle Public read, tenant-level admin write.
     */
    match /tenants/{tenantId}/orders/{orderId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if isSuperAdmin() && resource != null;
    }

    /**
     * @description Allows access to table documents within a tenant.
     * @path /tenants/{tenantId}/tables/{tableId}
     * @allow get, list: if true; // Public read for tables
     * @allow create: if isSignedIn();
     * @allow update, delete: if isSuperAdmin() && resource != null; // Owner only for write
     * @deny create: if !isSignedIn();
     * @deny update: if !isSuperAdmin() && resource != null;
     * @deny delete: if !isSuperAdmin() && resource != null;
     * @principle Public read, tenant-level admin write.
     */
    match /tenants/{tenantId}/tables/{tableId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if isSuperAdmin() && resource != null;
    }
  }
}