rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     * @return {boolean} True if the request is authenticated, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource.
     * @param {string} userId - The user ID to compare against the authenticated user's UID.
     * @return {boolean} True if the user is the owner, false otherwise.
     * @example isOwner('user123') returns true if request.auth.uid == 'user123'.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource, and if the resource exists.
     * @param {string} userId - The user ID to compare against the authenticated user's UID.
     * @return {boolean} True if the user is the owner and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the authenticated user is a superadmin.
     * @return {boolean} True if the user is a superadmin, false otherwise.
     */
    function isSuperAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_superadmin/$(request.auth.uid));
    }

    /**
     * @description Checks if the authenticated user is an admin_kafe for the given tenant.
     * @param {string} tenantId - The tenant ID to check against the user's tenantId.
     * @return {boolean} True if the user is an admin_kafe for the tenant, false otherwise.
     */
    function isAdminKafe(tenantId) {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin_kafe';
    }

    /**
     * @description Allows superadmins full access, and tenant admins to update their own tenant document.
     * @path /tenants/{tenantId}
     * @allow (read, get) if isSuperAdmin()
     * @allow (update) if isAdminKafe(tenantId)
     * @deny (create) if !isSuperAdmin()
     * @deny (delete) if !isSuperAdmin()
     * @principle Enforces role-based access control for tenant management.
     */
    match /tenants/{tenantId} {
      allow get: if true;
      allow list: if false; // Disable listing
      allow create: if isSuperAdmin();
      allow update: if isSuperAdmin() || (isSignedIn() && isAdminKafe(tenantId) && request.auth.uid == resource.data.adminId);
      allow delete: if isSuperAdmin();
    }

    /**
     * @description Allows superadmins full access to user data.
     * @path /users/{userId}
     * @allow (read) if isSuperAdmin()
     * @allow (create) if isSuperAdmin()
     * @deny (update) if !isSuperAdmin()
     * @deny (delete) if !isSuperAdmin()
     * @principle Restricts user management to superadmins only.
     */
    match /users/{userId} {
      allow get: if isSuperAdmin();
      allow list: if false;
      allow create: if isSuperAdmin();
      allow update: if isSuperAdmin();
      allow delete: if isSuperAdmin();
    }

    /**
     * @description Allows tenant admins to manage menu items within their tenant.
     * @path /tenants/{tenantId}/menus/{menuId}
     * @allow (read) if isAdminKafe(tenantId)
     * @allow (create) if isAdminKafe(tenantId)
     * @deny (update) if !isAdminKafe(tenantId)
     * @deny (delete) if !isAdminKafe(tenantId)
     * @principle Enforces tenant-level data ownership for menu management.
     */
    match /tenants/{tenantId}/menus/{menuId} {
      allow get: if true; // Allow public read
      allow list: if true; // Allow public listing for the app to work for anonymous users.
      allow create: if isSignedIn() && isAdminKafe(tenantId);
      allow update: if isSignedIn() && isAdminKafe(tenantId);
      allow delete: if isSignedIn() && isAdminKafe(tenantId);
    }

    /**
     * @description Allows tenant admins to manage menu categories within their tenant.
     * @path /tenants/{tenantId}/categories/{categoryId}
     * @allow (read) if isAdminKafe(tenantId)
     * @allow (create) if isAdminKafe(tenantId)
     * @deny (update) if !isAdminKafe(tenantId)
     * @deny (delete) if !isAdminKafe(tenantId)
     * @principle Enforces tenant-level data ownership for category management.
     */
    match /tenants/{tenantId}/categories/{categoryId} {
      allow get: if true; // Allow public read.
      allow list: if true; // Allow public listing for the app to work for anonymous users.
      allow create: if isSignedIn() && isAdminKafe(tenantId);
      allow update: if isSignedIn() && isAdminKafe(tenantId);
      allow delete: if isSignedIn() && isAdminKafe(tenantId);
    }

    /**
     * @description Allows tenant admins to manage orders within their tenant, and allows customers to create orders with token verification.
     * @path /tenants/{tenantId}/orders/{orderId}
     * @allow (read) if isAdminKafe(tenantId)
     * @allow (create) if request.auth == null && request.resource.data.verificationToken == get(/databases/(default)/documents/tenants/$(request.resource.data.tenantId)).data.tokenHarian
     * @deny (update) if !isAdminKafe(tenantId)
     * @deny (delete) if !isAdminKafe(tenantId)
     * @principle Enforces tenant-level data ownership for order management, and token-based verification for customer orders.
     */
    match /tenants/{tenantId}/orders/{orderId} {
      allow get: if isSignedIn() && isAdminKafe(tenantId);
      allow list: if isSignedIn() && isAdminKafe(tenantId);
      allow create: if request.auth == null && request.resource.data.tenantId == tenantId && request.resource.data.verificationToken == get(/databases/$(database)/documents/tenants/$(tenantId)).data.tokenHarian;
      allow update: if isSignedIn() && isAdminKafe(tenantId);
      allow delete: if isSignedIn() && isAdminKafe(tenantId);
    }

    /**
     * @description Allows tenant admins to manage tables within their tenant.
     * @path /tenants/{tenantId}/tables/{tableId}
     * @allow (read) if isAdminKafe(tenantId)
     * @allow (update) if isAdminKafe(tenantId)
     * @deny (create) if !isAdminKafe(tenantId)
     * @deny (delete) if !isAdminKafe(tenantId)
     * @principle Enforces tenant-level data ownership for table management.
     */
    match /tenants/{tenantId}/tables/{tableId} {
      allow get: if isSignedIn() && isAdminKafe(tenantId);
      allow list: if isSignedIn() && isAdminKafe(tenantId);
      allow create: if isSignedIn() && isAdminKafe(tenantId);
      allow update: if isSignedIn() && isAdminKafe(tenantId);
      allow delete: if isSignedIn() && isAdminKafe(tenantId);
    }

    /**
     * @description Allows read access for superadmins and deny all write access to superadmin roles.
     * @path /roles_superadmin/{userId}
     */
    match /roles_superadmin/{userId} {
      allow get: if isSuperAdmin();
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
    
    /**
     * @description This rule was created to fix the error reported. Anonymous users need to be able to read Tenants.
     * @path /tenants
     */
    match /tenants {
      allow get: if false;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}