
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =================================
    // Helper Functions
    // =================================
    function isSuperAdmin() {
      // Periksa apakah UID pengguna ada di koleksi roles_superadmin
      return exists(/databases/$(database)/documents/roles_superadmin/$(request.auth.uid));
    }

    function isCafeAdmin(tenantId) {
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return userDoc.data.role == 'admin_kafe' && userDoc.data.tenantId == tenantId;
    }
    
    function isSignedIn() {
        return request.auth != null;
    }


    // =================================
    // Collection: tenants
    // =================================
    match /tenants/{tenantId} {
      // SIAPA SAJA (termasuk anonim) bisa membaca (get) detail satu tenant.
      // Ini penting agar aturan untuk sub-koleksi di bawahnya bisa dievaluasi.
      allow get: if true;

      // HANYA Super Admin yang bisa membuat, menghapus, atau melihat daftar semua tenant.
      allow list, create, delete: if isSignedIn() && isSuperAdmin();

      // Admin Kafe bisa mengupdate tenantnya sendiri, Super Admin bisa update semua.
      allow update: if isSignedIn() && (isSuperAdmin() || isCafeAdmin(tenantId));
    }

    // =================================
    // Collection: users
    // =================================
    match /users/{userId} {
      // HANYA Super Admin yang bisa melihat, membuat, atau menghapus data user lain.
      allow read, write: if isSignedIn() && isSuperAdmin();

      // User hanya bisa mengupdate datanya sendiri (jika diperlukan di masa depan).
      allow update: if isSignedIn() && request.auth.uid == userId;
    }
    
    // =================================
    // Tenant Sub-collections
    // =================================
    
    // Aturan untuk /menus, /tables, dan /categories
    match /tenants/{tenantId}/{collectionName in ['menus', 'tables', 'categories']} {
        // SIAPA SAJA (termasuk anonim) bisa membaca daftar menu, meja, dan kategori.
        allow get, list: if true;

        // HANYA Admin Kafe dari tenant tersebut (atau Super Admin) yang bisa mengubah data.
        allow write: if isSignedIn() && (isSuperAdmin() || isCafeAdmin(tenantId));
    }

    // Aturan spesifik untuk /orders
    match /tenants/{tenantId}/orders/{orderId} {
        // HANYA Admin Kafe (atau Super Admin) yang bisa membaca semua order atau mengupdatenya.
        allow get, list, update: if isSignedIn() && (isSuperAdmin() || isCafeAdmin(tenantId));

        // SIAPA SAJA (termasuk anonim) bisa membuat order BARU,
        // DENGAN SYARAT: token verifikasi yang dikirim harus sama dengan token harian tenant.
        allow create: if request.resource.data.verificationToken == get(/databases/$(database)/documents/tenants/$(tenantId)).data.tokenHarian;
    }
    
    // =================================
    // Collection: roles_superadmin
    // =================================
    match /roles_superadmin/{userId} {
      // Hanya Super Admin lain yang bisa melihat atau mengubah koleksi ini.
      allow read, write: if isSignedIn() && isSuperAdmin();
    }
  }
}
