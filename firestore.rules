/**
 * @file Overview
 * This ruleset enforces a multi-tenant security model for the AirCafe application.
 *
 * Core Philosophy:
 * Access is primarily controlled by tenant ownership. Users can only access data belonging to their assigned tenant.
 * Superadmins have unrestricted access to all tenants' data. The anti-spam measure implemented through the `verificationToken` ensures that only valid orders are created.
 * 
 * Data Structure:
 * - /tenants/{tenantId}: Stores tenant-specific information.
 * - /users/{userId}: Stores user profiles, including tenant and role assignments.
 * - /tenants/{tenantId}/menus/{menuId}: Stores menu items for each tenant.
 * - /tenants/{tenantId}/categories/{categoryId}: Stores menu categories for each tenant.
 * - /tenants/{tenantId}/orders/{orderId}: Stores orders for each tenant.
 * - /tenants/{tenantId}/tables/{tableId}: Stores tables for each tenant.
 * - /roles_superadmin/{userId}: Stores user IDs of superadmins. Document existence grants superadmin privileges.
 *
 * Key Security Decisions:
 * - Superadmin privileges are determined by the presence of a document in `/roles_superadmin/{userId}`.
 * - All subcollections under `/tenants/{tenantId}` inherit tenant-based access control.
 * - The `verificationToken` in the `Order` document must match the `tokenHarian` in the `Tenant` document to prevent spam.
 * - Listing of menus, categories, and tables are allowed for all users.
 * - Listing of orders is allowed for superadmins only.
 *
 * Denormalization for Authorization:
 * - The `tenantId` field is duplicated across all subcollections under `/tenants/{tenantId}` (menus, categories, orders, tables) to enable Authorization Independence.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows read access to all tenant documents. Only superadmins can create, update, or delete tenant documents.
     * @path /tenants/{tenantId}
     * @allow get, list: if true;
     * @allow create: if false;
     * @allow update: if false;
     * @allow delete: if false;
     * @principle Public read, restricted write access to tenant information.
     */
    match /tenants/{tenantId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows access to user documents based on ownership.
     * @path /users/{userId}
     * @allow get, list: if isOwner(userId);
     * @allow create: if isOwner(userId);
     * @allow update: if isOwner(userId);
     * @allow delete: if isOwner(userId);
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows read access to menu items for all users. Only users with the 'admin_kafe' role for the tenant can create, update, or delete menu items.
     * @path /tenants/{tenantId}/menus/{menuId}
     * @allow get, list: if true;
     * @allow create: if isAdminKafe(tenantId);
     * @allow update: if isAdminKafe(tenantId) && resource != null;
     * @allow delete: if isAdminKafe(tenantId) && resource != null;
     * @principle Public read, admin-restricted write access to menu items.
     */
    match /tenants/{tenantId}/menus/{menuId} {
      allow get, list: if true;
      allow create: if isAdminKafe(tenantId);
      allow update: if isAdminKafe(tenantId) && resource != null;
      allow delete: if isAdminKafe(tenantId) && resource != null;
    }

    /**
     * @description Allows read access to categories for all users. Only users with the 'admin_kafe' role for the tenant can create, update, or delete categories.
     * @path /tenants/{tenantId}/categories/{categoryId}
     * @allow get, list: if true;
     * @allow create: if isAdminKafe(tenantId);
     * @allow update: if isAdminKafe(tenantId) && resource != null;
     * @allow delete: if isAdminKafe(tenantId) && resource != null;
     * @principle Public read, admin-restricted write access to menu categories.
     */
    match /tenants/{tenantId}/categories/{categoryId} {
      allow get, list: if true;
      allow create: if isAdminKafe(tenantId);
      allow update: if isAdminKafe(tenantId) && resource != null;
      allow delete: if isAdminKafe(tenantId) && resource != null;
    }

    /**
     * @description Allows access to orders based on the user's role and tenant.
     * @path /tenants/{tenantId}/orders/{orderId}
     * @allow get: if isAdminKafe(tenantId) || isSuperAdmin();
     * @allow list: if isSuperAdmin();
     * @allow create: if isValidOrder(tenantId);
     * @allow update: if isAdminKafe(tenantId) && resource != null;
     * @allow delete: if isAdminKafe(tenantId) && resource != null;
     * @principle Restricts order access to authorized users and validates order integrity.
     */
    match /tenants/{tenantId}/orders/{orderId} {
      allow get: if isAdminKafe(tenantId) || isSuperAdmin();
      allow list: if isSuperAdmin();
      allow create: if isValidOrder(tenantId);
      allow update: if isAdminKafe(tenantId) && resource != null;
      allow delete: if isAdminKafe(tenantId) && resource != null;
    }

    /**
     * @description Allows read access to tables for all users. Only users with the 'admin_kafe' role for the tenant can create, update, or delete tables.
     * @path /tenants/{tenantId}/tables/{tableId}
     * @allow get, list: if true;
     * @allow create: if isAdminKafe(tenantId);
     * @allow update: if isAdminKafe(tenantId) && resource != null;
     * @allow delete: if isAdminKafe(tenantId) && resource != null;
     * @principle Public read, admin-restricted write access to tables.
     */
    match /tenants/{tenantId}/tables/{tableId} {
      allow get, list: if true;
      allow create: if isAdminKafe(tenantId);
      allow update: if isAdminKafe(tenantId) && resource != null;
      allow delete: if isAdminKafe(tenantId) && resource != null;
    }

    /**
     * @description Allows superadmins to manage roles by creating or deleting documents.
     * @path /roles_superadmin/{userId}
     * @allow get: if isSuperAdmin();
     * @allow list: if isSuperAdmin();
     * @allow create: if isSuperAdmin();
     * @allow update: if false;
     * @allow delete: if isSuperAdmin();
     * @principle Restricts role management to superadmins.
     */
    match /roles_superadmin/{userId} {
      allow get: if isSuperAdmin();
      allow list: if isSuperAdmin();
      allow create: if isSuperAdmin();
      allow update: if false;
      allow delete: if isSuperAdmin();
    }

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isSuperAdmin() {
      return exists(/databases/$(database)/documents/roles_superadmin/$(request.auth.uid));
    }

    function isAdminKafe(tenantId) {
        return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin_kafe';
    }

    function isValidOrder(tenantId) {
        return isSignedIn() && request.resource.data.tenantId == tenantId && request.resource.data.verificationToken == get(/databases/$(database)/documents/tenants/$(tenantId)).data.tokenHarian;
    }
  }
}