
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =================================
    // Helper Functions
    // =================================
    function isSuperAdmin() {
      // Periksa apakah UID pengguna ada di koleksi roles_superadmin
      return exists(/databases/$(database)/documents/roles_superadmin/$(request.auth.uid));
    }

    function isCafeAdmin(tenantId) {
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return userDoc.data.role == 'admin_kafe' && userDoc.data.tenantId == tenantId;
    }
    
    function isSignedIn() {
        return request.auth != null;
    }


    // =================================
    // Global Unprotected Rule (FOR DEVELOPMENT)
    // =================================
    // Izinkan SEMUA PENGGUNA TERAUTENTIKASI (termasuk anonim) untuk membaca dan menulis
    // di seluruh database. Ini adalah aturan sementara untuk debugging.
    match /{path=**} {
      allow read, write: if isSignedIn();
    }


    // =================================
    // Collection: users & roles_superadmin (PROTECTED)
    // =================================
    // Aturan ini ditempatkan setelah aturan global untuk menimpanya secara spesifik.
    // Aturan yang lebih spesifik akan diutamakan.
    
    match /users/{userId} {
      // HANYA Super Admin yang bisa melihat, membuat, atau menghapus data user lain.
      allow read, write: if isSignedIn() && isSuperAdmin();

      // User hanya bisa mengupdate datanya sendiri (jika diperlukan di masa depan).
      allow update: if isSignedIn() && request.auth.uid == userId;
    }

    match /roles_superadmin/{userId} {
      // Hanya Super Admin lain yang bisa melihat atau mengubah koleksi ini.
      allow read, write: if isSignedIn() && isSuperAdmin();
    }
  }
}
