/**
 * @file Firestore Security Rules for AirCafe Application
 * @version Prototyping
 *
 * @description
 * This ruleset enforces a multi-tenant security model where each cafe (tenant) has its own set of data.
 * Users are associated with a specific tenant and have the 'admin_kafe' role.  Super admins are managed through a dedicated collection `roles_superadmin`.
 *
 * @dataStructure
 * - `/tenants/{tenantId}`: Stores cafe tenant profiles.
 * - `/users/{userId}`: Stores cafe admin user profiles. Each user belongs to a tenant.
 * - `/roles_superadmin/{userId}`: Stores super admin user roles.  The document ID is the user's UID.
 * - `/tenants/{tenantId}/menus/{menuId}`: Stores menu items for a specific tenant.
 * - `/tenants/{tenantId}/categories/{categoryId}`: Stores menu categories for a specific tenant.
 * - `/tenants/{tenantId}/orders/{orderId}`: Stores orders placed at a specific tenant.
 * - `/tenants/{tenantId}/tables/{tableId}`: Stores tables for a specific tenant.
 *
 * @keySecurityDecisions
 * - Users can only manage data within their assigned tenant.
 * - Super admin roles are explicitly managed in the `roles_superadmin` collection, and those roles grant elevated permissions.
 * - Listing of users is disallowed.
 *
 * @denormalizationForAuthorization
 * - The `User` document includes a `tenantId` field to simplify tenant-based authorization.
 *
 * @structuralSegregation
 * - No structural segregation is applied in this version.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants read and write access to tenant documents.  Write access is restricted to super admins.
     * @path /tenants/{tenantId}
     * @allow (get, list): if true;
     * @allow (create, update, delete): if isSuperAdmin();
     * @deny (create, update, delete): if !isSuperAdmin();
     * @principle Allows any reads but restricts writes to super admins.
     */
    match /tenants/{tenantId} {
      allow get, list: if true;
      allow create, update, delete: if isSuperAdmin();
    }

    /**
     * @description Grants read and write access to user documents.  Users can create their own profile.  Tenant admins can manage users within their tenant.
     * @path /users/{userId}
     * @allow (get): if isOwner(userId) || isTenantAdminForUser(userId);
     * @allow (list): if false;
     * @allow (create): if isSelfCreate(userId);
     * @allow (update, delete): if isOwner(userId) || isTenantAdminForUser(userId);
     * @deny (create): if !isSelfCreate(userId);
     * @deny (update, delete): if !(isOwner(userId) || isTenantAdminForUser(userId));
     * @principle Enforces user ownership and tenant-based administration.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isTenantAdminForUser(userId);
      allow list: if false;
      allow create: if isSelfCreate(userId);
      allow update, delete: if isOwner(userId) || isTenantAdminForUser(userId);
    }

    /**
     * @description Grants read and write access to super admin role documents.  Only super admins can manage other super admins.
     * @path /roles_superadmin/{userId}
     * @allow (get): if isSuperAdmin() || isOwner(userId);
     * @allow (list): if isSuperAdmin();
     * @allow (create, update, delete): if isSuperAdmin();
     * @deny (create, update, delete): if !isSuperAdmin();
     * @principle Restricts super admin management to existing super admins.
     */
    match /roles_superadmin/{userId} {
      allow get: if isSuperAdmin() || isOwner(userId);
      allow list: if isSuperAdmin();
      allow create, update, delete: if isSuperAdmin();
    }

    /**
     * @description Grants read and write access to menu items within a tenant.  Tenant admins can manage menu items for their tenant.
     * @path /tenants/{tenantId}/menus/{menuId}
     * @allow (get, list): if isTenantAdmin(tenantId);
     * @allow (create, update, delete): if isTenantAdmin(tenantId);
     * @deny (create, update, delete): if !isTenantAdmin(tenantId);
     * @principle Enforces tenant-based access control for menu items.
     */
    match /tenants/{tenantId}/menus/{menuId} {
      allow get, list: if isTenantAdmin(tenantId);
      allow create, update, delete: if isTenantAdmin(tenantId);
    }

    /**
     * @description Grants read and write access to menu categories within a tenant. Tenant admins can manage categories for their tenant.
     * @path /tenants/{tenantId}/categories/{categoryId}
     * @allow (get, list): if isTenantAdmin(tenantId);
     * @allow (create, update, delete): if isTenantAdmin(tenantId);
     * @deny (create, update, delete): if !isTenantAdmin(tenantId);
     * @principle Enforces tenant-based access control for menu categories.
     */
    match /tenants/{tenantId}/categories/{categoryId} {
      allow get, list: if isTenantAdmin(tenantId);
      allow create, update, delete: if isTenantAdmin(tenantId);
    }

    /**
     * @description Grants read and write access to orders within a tenant. Tenant admins can manage orders for their tenant.
     * @path /tenants/{tenantId}/orders/{orderId}
     * @allow (get, list): if isTenantAdmin(tenantId);
     * @allow (create, update, delete): if isTenantAdmin(tenantId);
     * @deny (create, update, delete): if !isTenantAdmin(tenantId);
     * @principle Enforces tenant-based access control for orders.
     */
    match /tenants/{tenantId}/orders/{orderId} {
      allow get, list: if isTenantAdmin(tenantId);
      allow create, update, delete: if isTenantAdmin(tenantId);
    }

    /**
     * @description Grants read and write access to tables within a tenant. Tenant admins can manage tables for their tenant.
     * @path /tenants/{tenantId}/tables/{tableId}
     * @allow (get, list): if isTenantAdmin(tenantId);
     * @allow (create, update, delete): if isTenantAdmin(tenantId);
     * @deny (create, update, delete): if !isTenantAdmin(tenantId);
     * @principle Enforces tenant-based access control for tables.
     */
    match /tenants/{tenantId}/tables/{tableId} {
      allow get, list: if isTenantAdmin(tenantId);
      allow create, update, delete: if isTenantAdmin(tenantId);
    }

    // ------ Helper Functions ------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
        return isOwner(userId) && resource.data.id == userId;
    }

    function isSelfCreate(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isTenantAdmin(tenantId) {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin_kafe';
    }

    function isTenantAdminForUser(userId) {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(userId)).data.tenantId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin_kafe';
    }

    function isSuperAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_superadmin/$(request.auth.uid));
    }
  }
}