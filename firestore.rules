/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a multi-tenant security model for the AirCafe application.
 *
 * Data Structure:
 * - /tenants/{tenantId}: Stores tenant-specific data.
 * - /users/{userId}: Stores user profiles, linked to a specific tenant.
 * - /roles_superadmin/{userId}: Stores superadmin roles.
 * - /tenants/{tenantId}/menus/{menuId}: Stores menu items for a tenant.
 * - /tenants/{tenantId}/categories/{categoryId}: Stores menu categories for a tenant.
 * - /tenants/{tenantId}/orders/{orderId}: Stores orders for a tenant.
 * - /tenants/{tenantId}/tables/{tableId}: Stores tables for a tenant.
 *
 * Key Security Decisions:
 * - Users can only access data within their assigned tenant.
 * - Superadmin roles are stored in the `roles_superadmin` collection and are used to grant elevated privileges.
 * - User listing is disallowed for privacy.
 * - All write operations are strictly controlled and require authentication.
 *
 * Denormalization for Authorization:
 * - User documents contain a `tenantId` field, which is used to enforce tenant-level access control.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants full access to superadmins; Tenants are read-only; others are denied.
     * @path /tenants/{tenantId}
     * @allow (get, list): if true
     * @allow (create, update, delete): if isAdmin()
     * @deny (create, update, delete): if !isAdmin()
     * @principle Enforces read-only access for non-admins and write access for superadmins.
     */
    match /tenants/{tenantId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Grants owner-only access to user profiles.
     * @path /users/{userId}
     * @allow (create): if isOwner(userId)
     * @allow (get, update, delete): if isExistingOwner(userId)
     * @deny (list): always
     * @principle Enforces strict user-ownership for user profile data.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Grants superadmin access to roles_superadmin collection.
     * @path /roles_superadmin/{userId}
     * @allow (create, get, update, delete, list): if isAdmin()
     * @deny (create, get, update, delete, list): if !isAdmin()
     * @principle Restricts access to superadmin role management to other superadmins.
     */
    match /roles_superadmin/{userId} {
      allow get, list, create, update, delete: if isAdmin();
    }

    /**
     * @description Grants tenant admins access to menu items within their tenant.
     * @path /tenants/{tenantId}/menus/{menuId}
     * @allow (get, list): if isTenantAdmin(tenantId)
     * @allow (create): if isTenantAdmin(tenantId)
     * @allow (update, delete): if isExistingTenantAdmin(tenantId)
     * @principle Enforces tenant-level access control for menu items.
     */
    match /tenants/{tenantId}/menus/{menuId} {
      allow get, list: if isTenantAdmin(tenantId);
      allow create: if isTenantAdmin(tenantId);
      allow update: if isExistingTenantAdmin(tenantId);
      allow delete: if isExistingTenantAdmin(tenantId);
    }

    /**
     * @description Grants tenant admins access to menu categories within their tenant.
     * @path /tenants/{tenantId}/categories/{categoryId}
     * @allow (get, list): if isTenantAdmin(tenantId)
     * @allow (create): if isTenantAdmin(tenantId)
     * @allow (update, delete): if isExistingTenantAdmin(tenantId)
     * @principle Enforces tenant-level access control for menu categories.
     */
    match /tenants/{tenantId}/categories/{categoryId} {
      allow get, list: if isTenantAdmin(tenantId);
      allow create: if isTenantAdmin(tenantId);
      allow update: if isExistingTenantAdmin(tenantId);
      allow delete: if isExistingTenantAdmin(tenantId);
    }

    /**
     * @description Grants tenant admins access to orders within their tenant.
     * @path /tenants/{tenantId}/orders/{orderId}
     * @allow (get, list): if isTenantAdmin(tenantId)
     * @allow (create): if isTenantAdmin(tenantId);
      * @allow (update): if isExistingTenantAdmin(tenantId)
     * @allow (delete): if isExistingTenantAdmin(tenantId);
     * @principle Enforces tenant-level access control for orders.
     */
    match /tenants/{tenantId}/orders/{orderId} {
      allow get, list: if isTenantAdmin(tenantId);
      allow create: if isTenantAdmin(tenantId);
      allow update: if isExistingTenantAdmin(tenantId);
      allow delete: if isExistingTenantAdmin(tenantId);
    }

    /**
     * @description Grants tenant admins access to tables within their tenant.
     * @path /tenants/{tenantId}/tables/{tableId}
     * @allow (get, list): if isTenantAdmin(tenantId)
     * @allow (create): if isTenantAdmin(tenantId)
     * @allow (update, delete): if isExistingTenantAdmin(tenantId)
     * @principle Enforces tenant-level access control for tables.
     */
    match /tenants/{tenantId}/tables/{tableId} {
      allow get, list: if isTenantAdmin(tenantId);
      allow create: if isTenantAdmin(tenantId);
      allow update: if isExistingTenantAdmin(tenantId);
      allow delete: if isExistingTenantAdmin(tenantId);
    }

    // --- Helper functions ---

    /**
     * @description Checks if the user is signed in.
     * @return True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user is the owner of the resource.
     * @param {string} userId - The user ID to check against.
     * @return True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is the owner of the resource and the resource exists.
     * @param {string} userId - The user ID to check against.
     * @return True if the user is the owner and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the user is a superadmin.
     * @return True if the user is a superadmin, false otherwise.
     */
    function isAdmin() {
        return exists(/databases/$(database)/documents/roles_superadmin/$(request.auth.uid));
    }

    /**
     * @description Checks if the user is an admin for the specified tenant.
     * @param {string} tenantId - The tenant ID to check against.
     * @return True if the user is a tenant admin, false otherwise.
     */
    function isTenantAdmin(tenantId) {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
    }

    /**
     * @description Checks if the user is an admin for the specified tenant and the resource exists.
     * @param {string} tenantId - The tenant ID to check against.
     * @return True if the user is a tenant admin and the resource exists, false otherwise.
     */
    function isExistingTenantAdmin(tenantId) {
      return isTenantAdmin(tenantId) && resource != null;
    }
  }
}