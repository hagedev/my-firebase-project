/**
 * @file Firebase Security Rules for AirCafe Application
 *
 * @description This ruleset enforces a multi-tenant data model where each cafe (tenant) has its own isolated data.
 *   Superadmins have broad access, while regular users are restricted to their assigned tenant.
 *
 * @dataStructure
 *   - /tenants/{tenantId}: Stores cafe tenant profiles.
 *   - /users/{userId}: Stores user profiles with roles and tenant assignments.
 *   - /tenants/{tenantId}/menus/{menuId}: Stores menu items for each tenant.
 *   - /tenants/{tenantId}/categories/{categoryId}: Stores menu categories for each tenant.
 *   - /tenants/{tenantId}/orders/{orderId}: Stores orders placed at each tenant.
 *   - /tenants/{tenantId}/tables/{tableId}: Stores table information for each tenant.
 *   - /roles_superadmin/{userId}: Documents in this collection indicate superadmin privileges.
 *
 * @keySecurityDecisions
 *   - Strict user-ownership model for user profiles.
 *   - Tenant-based access control for cafe-specific data.
 *   - Superadmin role is determined by the presence of a document in `/roles_superadmin/{userId}`.
 *   - Denormalization of `tenantId` in subcollections for efficient authorization.
 *   - Orders are validated against a tenant-specific daily token to prevent spam.
 *   - Listing of users is disallowed to prevent information disclosure.
 *
 * @denormalizationForAuthorization
 *   - The `tenantId` is duplicated in all subcollections under `/tenants/{tenantId}` to allow rules to validate tenant-level access without extra `get()` calls.
 *
 * @structuralSegregation
 *   - Tenant-specific data is segregated into subcollections under each tenant's document, ensuring clear data ownership and isolation.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the requesting user is signed in.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the requesting user's ID matches the provided userId.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the requesting user is an existing owner of the document.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the requesting user is a superadmin, by validating the existence of the `/roles_superadmin/{userId}` document
     */
    function isSuperAdmin() {
      return exists(/databases/$(database)/documents/roles_superadmin/$(request.auth.uid));
    }

    /**
     * @description Rules for the /tenants collection.
     * @path /tenants/{tenantId}
     * @allow (get) Anyone can read tenant information.
     * @allow (create) Only superadmins can create tenants. Requires valid tenant data.
     * @allow (update, delete) Only superadmins can update or delete tenants.
     * @deny (create) Regular users cannot create tenants.
     * @deny (update, delete) Regular users cannot modify or delete tenants.
     * @principle Requires superadmin role for tenant creation and modification. Allows public read access.
     */
    match /tenants/{tenantId} {
      allow get: if true; // Public read for tenant information.
      allow create: if isSuperAdmin();
      allow update: if isSuperAdmin();
      allow delete: if isSuperAdmin();
    }

    /**
     * @description Rules for the /users collection.
     * @path /users/{userId}
     * @allow (get) Only the user themselves can read their profile.
     * @allow (create) Only the user themselves can create their profile. The userId must match the auth.uid.
     * @allow (update, delete) Only the user themselves can update or delete their profile.
     * @deny (get, list) No one can list all users.
     * @deny (create, update, delete) Other users cannot create, modify, or delete user profiles.
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // Prevent listing of all users.
      allow create: if isOwner(userId) && request.auth.uid == userId;
      allow update: if isOwner(userId); // Enforce immutability of user ID
      allow delete: if isOwner(userId);
    }

    /**
     * @description Rules for the /tenants/{tenantId}/menus collection.
     * @path /tenants/{tenantId}/menus/{menuId}
     * @allow (get, list) Anyone can read menu items.
     * @allow (create, update, delete) Only superadmins or tenant admins can create, modify, or delete menu items within their tenant.
     * @deny (create, update, delete) Regular users cannot modify menu items.
     * @principle Tenant-based access control for menus. Requires tenant admin or superadmin role for writes. Allows public read access.
     */
    match /tenants/{tenantId}/menus/{menuId} {
      allow get, list: if true;
      allow create: if isSuperAdmin();
      allow update: if isSuperAdmin();
      allow delete: if isSuperAdmin();
    }

    /**
     * @description Rules for the /tenants/{tenantId}/categories collection.
     * @path /tenants/{tenantId}/categories/{categoryId}
     * @allow (get, list) Anyone can read categories.
     * @allow (create, update, delete) Only superadmins or tenant admins can create, modify, or delete categories within their tenant.
     * @deny (create, update, delete) Regular users cannot modify categories.
     * @principle Tenant-based access control for categories. Requires tenant admin or superadmin role for writes. Allows public read access.
     */
    match /tenants/{tenantId}/categories/{categoryId} {
      allow get, list: if true;
      allow create: if isSuperAdmin();
      allow update: if isSuperAdmin();
      allow delete: if isSuperAdmin();
    }

    /**
     * @description Rules for the /tenants/{tenantId}/orders collection.
     * @path /tenants/{tenantId}/orders/{orderId}
     * @allow (get, list) Anyone can read orders.
     * @allow (create) Anyone can create orders
     * @allow (update, delete) Only superadmins or tenant admins can update or delete orders within their tenant.
     * @deny (create, update, delete) Regular users cannot modify orders.
     * @principle Tenant-based access control for orders. Requires tenant admin or superadmin role for writes. Allows public read access.
     */
    match /tenants/{tenantId}/orders/{orderId} {
      allow get, list: if true;
      allow create: if true;
      allow update: if isSuperAdmin();
      allow delete: if isSuperAdmin();
    }

    /**
     * @description Rules for the /tenants/{tenantId}/tables collection.
     * @path /tenants/{tenantId}/tables/{tableId}
     * @allow (get, list) Anyone can read tables.
     * @allow (create, update, delete) Only superadmins or tenant admins can create, modify, or delete tables within their tenant.
     * @deny (create, update, delete) Regular users cannot modify tables.
     * @principle Tenant-based access control for tables. Requires tenant admin or superadmin role for writes. Allows public read access.
     */
    match /tenants/{tenantId}/tables/{tableId} {
      allow get, list: if true;
      allow create: if isSuperAdmin();
      allow update: if isSuperAdmin();
      allow delete: if isSuperAdmin();
    }

     /**
      * @description Rules for the /roles_superadmin collection.
      * @path /roles_superadmin/{userId}
      * @allow (get) Only the user themselves can read their role.
      * @allow (create) Only the user themselves can create their role. The userId must match the auth.uid.
      * @allow (update, delete) Only the user themselves can update or delete their role.
      * @deny (get, list) No one can list all users.
      * @deny (create, update, delete) Other users cannot create, modify, or delete user profiles.
      * @principle Enforces document ownership for user profiles.
      */
    match /roles_superadmin/{userId} {
       allow get: if isOwner(userId) || isSuperAdmin();
       allow list: if false;
       allow create: if isOwner(userId) && request.auth.uid == userId;
       allow update: if false;
       allow delete: if isOwner(userId) || isSuperAdmin();
    }
  }
}