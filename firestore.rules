rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows superadmins to perform any operation, and tenant admins to perform operations within their own tenant.
     * @path /tenants/{tenantId}
     * @allow (get, list) if isSignedIn() && (isSuperAdmin() || isTenantAdmin(tenantId));
     * @allow (create, update, delete) if isSignedIn() && (isSuperAdmin() || isTenantAdmin(tenantId));
     * @deny (create) if !isSignedIn()
     * @deny (update) if !isSignedIn()
     * @deny (delete) if !isSignedIn()
     * @principle Enforces tenant-level access control for tenant documents.
     */
    match /tenants/{tenantId} {
      allow get, list: if isSignedIn() && (isSuperAdmin() || isTenantAdmin(tenantId));
      allow create: if isSignedIn() && (isSuperAdmin() || isTenantAdmin(tenantId));
      allow update: if isSignedIn() && (isSuperAdmin() || isTenantAdmin(tenantId));
      allow delete: if isSignedIn() && (isSuperAdmin() || isTenantAdmin(tenantId));
    }

    /**
     * @description Restricts access to user documents to the owner only.
     * @path /users/{userId}
     * @allow (get, update, delete) if isSignedIn() && isOwner(userId);
     * @allow (create) if isSignedIn() && isSelfCreate(userId);
     * @deny (list) Always deny listing of users
     * @deny (create) if !isSignedIn() || !isSelfCreate(userId);
     * @deny (update) if !isSignedIn() || !isOwner(userId);
     * @deny (delete) if !isSignedIn() || !isOwner(userId);
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isSelfCreate(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Allows superadmins to perform any operation, and tenant admins to perform operations within their own tenant.
     * @path /tenants/{tenantId}/menus/{menuId}
     * @allow (get, list) if isSignedIn() && (isSuperAdmin() || isTenantAdmin(tenantId));
     * @allow (create, update, delete) if isSignedIn() && (isSuperAdmin() || isTenantAdmin(tenantId));
     * @deny (create) if !isSignedIn()
     * @deny (update) if !isSignedIn()
     * @deny (delete) if !isSignedIn()
     * @principle Enforces tenant-level access control for menu items.
     */
    match /tenants/{tenantId}/menus/{menuId} {
      allow get, list: if isSignedIn() && (isSuperAdmin() || isTenantAdmin(tenantId));
      allow create: if isSignedIn() && (isSuperAdmin() || isTenantAdmin(tenantId));
      allow update: if isSignedIn() && (isSuperAdmin() || isTenantAdmin(tenantId));
      allow delete: if isSignedIn() && (isSuperAdmin() || isTenantAdmin(tenantId));
    }

    /**
     * @description Allows superadmins to perform any operation, and tenant admins to perform operations within their own tenant.
     * @path /tenants/{tenantId}/categories/{categoryId}
     * @allow (get, list) if isSignedIn() && (isSuperAdmin() || isTenantAdmin(tenantId));
     * @allow (create, update, delete) if isSignedIn() && (isSuperAdmin() || isTenantAdmin(tenantId));
     * @deny (create) if !isSignedIn()
     * @deny (update) if !isSignedIn()
     * @deny (delete) if !isSignedIn()
     * @principle Enforces tenant-level access control for menu categories.
     */
    match /tenants/{tenantId}/categories/{categoryId} {
      allow get, list: if isSignedIn() && (isSuperAdmin() || isTenantAdmin(tenantId));
      allow create: if isSignedIn() && (isSuperAdmin() || isTenantAdmin(tenantId));
      allow update: if isSignedIn() && (isSuperAdmin() || isTenantAdmin(tenantId));
      allow delete: if isSignedIn() && (isSuperAdmin() || isTenantAdmin(tenantId));
    }

    /**
     * @description Allows superadmins to perform any operation, and tenant admins to perform operations within their own tenant.
     * @path /tenants/{tenantId}/orders/{orderId}
     * @allow (get, list) if isSignedIn() && (isSuperAdmin() || isTenantAdmin(tenantId));
     * @allow (create, update, delete) if isSignedIn() && (isSuperAdmin() || isTenantAdmin(tenantId));
     * @deny (create) if !isSignedIn()
     * @deny (update) if !isSignedIn()
     * @deny (delete) if !isSignedIn()
     * @principle Enforces tenant-level access control for orders.
     */
    match /tenants/{tenantId}/orders/{orderId} {
      allow get, list: if isSignedIn() && (isSuperAdmin() || isTenantAdmin(tenantId));
      allow create: if isSignedIn() && (isSuperAdmin() || isTenantAdmin(tenantId));
      allow update: if isSignedIn() && (isSuperAdmin() || isTenantAdmin(tenantId));
      allow delete: if isSignedIn() && (isSuperAdmin() || isTenantAdmin(tenantId));
    }

    /**
     * @description Allows superadmins to perform any operation, and tenant admins to perform operations within their own tenant.
     * @path /tenants/{tenantId}/tables/{tableId}
     * @allow (get, list) if isSignedIn() && (isSuperAdmin() || isTenantAdmin(tenantId));
     * @allow (create, update, delete) if isSignedIn() && (isSuperAdmin() || isTenantAdmin(tenantId));
     * @deny (create) if !isSignedIn()
     * @deny (update) if !isSignedIn()
     * @deny (delete) if !isSignedIn()
     * @principle Enforces tenant-level access control for tables.
     */
    match /tenants/{tenantId}/tables/{tableId} {
      allow get, list: if isSignedIn() && (isSuperAdmin() || isTenantAdmin(tenantId));
      allow create: if isSignedIn() && (isSuperAdmin() || isTenantAdmin(tenantId));
      allow update: if isSignedIn() && (isSuperAdmin() || isTenantAdmin(tenantId));
      allow delete: if isSignedIn() && (isSuperAdmin() || isTenantAdmin(tenantId));
    }

     /**
      * @description Allows superadmins to perform any operation.
      * @path /roles_superadmin/{userId}
      * @allow get, list: if isSignedIn() && isSuperAdmin();
      * @allow create, update, delete: if isSignedIn() && isSuperAdmin();
      * @deny create: if !isSignedIn() || !isSuperAdmin();
      * @deny update: if !isSignedIn() || !isSuperAdmin();
      * @deny delete: if !isSignedIn() || !isSuperAdmin();
      * @principle Enforces superadmin-only access control.
      */
    match /roles_superadmin/{userId} {
        allow get: if isSignedIn() && isSuperAdmin();
        allow list: if isSignedIn() && isSuperAdmin();
        allow create: if isSignedIn() && isSuperAdmin();
        allow update: if isSignedIn() && isSuperAdmin();
        allow delete: if isSignedIn() && isSuperAdmin();
    }
  }

  // Helper functions
  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return request.auth.uid == userId;
  }

  function isSelfCreate(userId) {
    return request.auth.uid == userId;
  }

  function isExistingOwner(userId) {
    return isOwner(userId) && resource != null;
  }

  function isSuperAdmin() {
    return exists(/databases/$(database)/documents/roles_superadmin/$(request.auth.uid));
  }

  function isTenantAdmin(tenantId) {
    return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
  }
}