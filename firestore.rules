/**
 * @fileOverview Firestore Security Rules for AirCafe - Prototyping Mode
 *
 * Core Philosophy:
 * This ruleset prioritizes strong authorization based on user identity and roles,
 * especially focusing on tenant-level access control. Data schema validation is relaxed
 * to allow rapid prototyping.  Rules are written to be auditable and maintainable
 * through the use of helper functions.
 *
 * Data Structure:
 * - /tenants/{tenantId}: Stores cafe tenant profiles.
 * - /users/{userId}: Stores user profiles and role assignments.
 * - /tenants/{tenantId}/menus/{menuId}: Stores menu items for a specific tenant.
 * - /tenants/{tenantId}/categories/{categoryId}: Stores menu categories for a specific tenant.
 * - /tenants/{tenantId}/orders/{orderId}: Stores orders placed at a specific tenant.
 * - /tenants/{tenantId}/tables/{tableId}: Stores tables for a specific tenant.
 * - /roles_superadmin/{userId}: Indicates superadmin privileges via document existence.
 *
 * Key Security Decisions:
 * - Strict tenant-level data isolation enforced. Users can only access data within their assigned tenant.
 * - Superadmins have unrestricted access to all tenant data, managed through a DBAC collection.
 * - Data validation is minimal, focusing on relational integrity and authorization.
 * - `list` operations are generally restricted to owners, except where public access is intended.
 * - The app structure uses path-based access control, sub-collections are parented under `/tenants/{tenantId}` to ensure that tenants can only read and write to their own resources.
 *
 * Denormalization for Authorization:
 * - The 'tenantId' is duplicated in all subcollections (menus, categories, tables, orders)
 *   to enable efficient security rules without requiring additional `get()` calls.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants access to tenant documents.
     * @path /tenants/{tenantId}
     * @allow (get, list): Anyone can read tenant data.
     * @allow (create, update, delete): Only superadmins can manage tenant data.
     * @deny (create, update, delete): Non-superadmins cannot modify tenant data.
     * @principle Enforces superadmin-only access for tenant management.
     */
    match /tenants/{tenantId} {
      allow get, list: if true; // Public read access for tenants.
      allow create, update, delete: if isSuperAdmin();
    }

    /**
     * @description Grants access to user documents.
     * @path /users/{userId}
     * @allow (get, list): Only the owner can read their own user data.
     * @allow (create): Only the user themselves can create their profile (Self-Creation).
     * @allow (update, delete): Only the owner can update/delete their own user data.
     * @deny (create): Creating a user document with an ID different from the authenticated user's UID.
     * @deny (update, delete): Modifying or deleting another user's profile.
     * @principle Enforces user-ownership for profile data.
     */
    match /users/{userId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update, delete: if isExistingOwner(userId);
    }

    /**
     * @description Grants access to menu documents under a tenant.
     * @path /tenants/{tenantId}/menus/{menuId}
     * @allow (get, list): Anyone can read menu data for a specific tenant.
     * @allow (create, update, delete): Only superadmins or tenant admins can manage menu data for their tenant.
     * @deny (create, update, delete): Users cannot modify menu data for other tenants.
     * @principle Enforces tenant-level access control for menu management.
     */
    match /tenants/{tenantId}/menus/{menuId} {
      allow get, list: if true; // Public read access for menus within a tenant.
      allow create, update, delete: if isSuperAdmin() || isTenantAdmin(tenantId);
    }

    /**
     * @description Grants access to category documents under a tenant.
     * @path /tenants/{tenantId}/categories/{categoryId}
     * @allow (get, list): Anyone can read category data for a specific tenant.
     * @allow (create, update, delete): Only superadmins or tenant admins can manage category data for their tenant.
     * @deny (create, update, delete): Users cannot modify category data for other tenants.
     * @principle Enforces tenant-level access control for category management.
     */
    match /tenants/{tenantId}/categories/{categoryId} {
      allow get, list: if true; // Public read access for categories within a tenant.
      allow create, update, delete: if isSuperAdmin() || isTenantAdmin(tenantId);
    }

    /**
     * @description Grants access to order documents under a tenant.
     * @path /tenants/{tenantId}/orders/{orderId}
     * @allow (get, list): Only superadmins or tenant admins can read order data for a specific tenant.
     * @allow (create): Only authenticated users can create order data, with token verification.
     * @allow (update, delete): Only superadmins or tenant admins can update/delete order data for their tenant.
     * @deny (create, update, delete): Users cannot modify order data for other tenants.
     * @principle Enforces tenant-level access control for order management, with token verification for creation.
     */
    match /tenants/{tenantId}/orders/{orderId} {
      allow get, list: if isSuperAdmin() || isTenantAdmin(tenantId);
      allow create: if isSignedIn();
      allow update, delete: if isSuperAdmin() || isTenantAdmin(tenantId);
    }

    /**
     * @description Grants access to table documents under a tenant.
     * @path /tenants/{tenantId}/tables/{tableId}
     * @allow (get, list): Only superadmins or tenant admins can read table data for a specific tenant.
     * @allow (create, update, delete): Only superadmins or tenant admins can manage table data for their tenant.
     * @deny (create, update, delete): Users cannot modify table data for other tenants.
     * @principle Enforces tenant-level access control for table management.
     */
    match /tenants/{tenantId}/tables/{tableId} {
      allow get, list: if isSuperAdmin() || isTenantAdmin(tenantId);
      allow create, update, delete: if isSuperAdmin() || isTenantAdmin(tenantId);
    }

     /**
      * @description Grants access to superadmin role documents.
      * @path /roles_superadmin/{userId}
      * @allow get, list: if false;
      * @allow create: if false;
      * @allow update: if false;
      * @allow delete: if false;
      * @principle Only the backend can manage the DBAC assignments for superadmins.
      */
    match /roles_superadmin/{userId} {
        allow get, list, create, update, delete: if false;
    }

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    function isSuperAdmin() {
      return exists(/databases/$(database)/documents/roles_superadmin/$(request.auth.uid));
    }

    function isTenantAdmin(tenantId) {
       return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
    }
  }
}