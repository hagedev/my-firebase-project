/**
 * @description This ruleset enforces a multi-tenant security model for the AirCafe application.
 * Superadmins, designated via the `/roles_superadmin/{userId}` collection, have full access.
 * Tenant admins (admin_kafe) have access only to their assigned tenant's data.
 *
 * @dataStructure
 * - /tenants/{tenantId}: Tenant profiles.
 * - /users/{userId}: User profiles with roles and tenant assignments.
 * - /tenants/{tenantId}/menus/{menuId}: Menu items.
 * - /tenants/{tenantId}/categories/{categoryId}: Menu categories.
 * - /tenants/{tenantId}/orders/{orderId}: Orders.
 * - /tenants/{tenantId}/tables/{tableId}: Tables.
 * - /roles_superadmin/{userId}: Superadmin role assignments (DBAC).
 *
 * @keySecurityDecisions
 * - Authorization Independence: All tenant-owned documents (menus, categories, orders, tables) include the `tenantId` field. This allows security rules to validate tenant-level access without additional reads.
 * - Superadmin Access: Superadmin privileges are determined by the existence of a document in the `/roles_superadmin/{userId}` collection.
 * - Anti-Spam: Order creation requires a `verificationToken` that matches the tenant's `tokenHarian`.
 * - No user listing is allowed.
 *
 * @denormalizationForAuthorization
 * - The `tenantId` field is denormalized into all tenant-owned documents (menus, categories, orders, tables) to enable Authorization Independence.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows read and write access to tenant profiles only to superadmins.
     * @path /tenants/{tenantId}
     * @allow (get, list): if isSignedIn() && isSuperAdmin()
     * @allow (create, update, delete): if isSignedIn() && isSuperAdmin()
     * @deny (get, list): if !isSignedIn() || !isSuperAdmin()
     * @deny (create, update, delete): if !isSignedIn() || !isSuperAdmin()
     * @principle Enforces superadmin-only access to tenant profiles.
     */
    match /tenants/{tenantId} {
      allow get, list: if isSignedIn() && isSuperAdmin();
      allow create, update, delete: if isSignedIn() && isSuperAdmin();
    }

    /**
     * @description Allows read and write access to user profiles only to superadmins and the user themselves.
     * @path /users/{userId}
     * @allow (get): if isSignedIn() && (isOwner(userId) || isSuperAdmin())
     * @allow (list): if isSignedIn() && isSuperAdmin()
     * @allow (create): if isSignedIn() && isSelfCreate(userId)
     * @allow (update, delete): if isSignedIn() && (isOwner(userId) || isSuperAdmin()) && resource != null;
     * @deny (get): if !isSignedIn() || (!isOwner(userId) && !isSuperAdmin())
     * @deny (list): if !isSignedIn() || !isSuperAdmin()
     * @deny (create): if !isSignedIn() || !isSelfCreate(userId)
     * @deny (update, delete): if !isSignedIn() || (!(isOwner(userId) || isSuperAdmin()) || resource == null)
     * @principle Enforces user-ownership for profile reads/writes and superadmin override.
     */
    match /users/{userId} {
      allow get: if isSignedIn() && (isOwner(userId) || isSuperAdmin());
      allow list: if isSignedIn() && isSuperAdmin();
      allow create: if isSignedIn() && isSelfCreate(userId);
      allow update, delete: if isSignedIn() && (isOwner(userId) || isSuperAdmin()) && resource != null;
    }

    /**
     * @description Allows read and write access to menu items for a specific tenant to tenant admins and superadmins.
     * @path /tenants/{tenantId}/menus/{menuId}
     * @allow (get, list): if isSignedIn() && (isTenantAdmin(tenantId) || isSuperAdmin())
     * @allow (create): if isSignedIn() && (isTenantAdmin(tenantId) || isSuperAdmin())
     * @allow (update, delete): if isSignedIn() && (isTenantAdmin(tenantId) || isSuperAdmin()) && resource != null;
     * @deny (get, list): if !isSignedIn() || (!isTenantAdmin(tenantId) && !isSuperAdmin())
     * @deny (create): if !isSignedIn() || (!isTenantAdmin(tenantId) && !isSuperAdmin())
     * @deny (update, delete): if !isSignedIn() || (!(isTenantAdmin(tenantId) || isSuperAdmin()) || resource == null)
     * @principle Enforces tenant-admin or superadmin access for menu management.
     */
    match /tenants/{tenantId}/menus/{menuId} {
      allow get, list: if isSignedIn() && (isTenantAdmin(tenantId) || isSuperAdmin());
      allow create: if isSignedIn() && (isTenantAdmin(tenantId) || isSuperAdmin());
      allow update, delete: if isSignedIn() && (isTenantAdmin(tenantId) || isSuperAdmin()) && resource != null;
    }

    /**
     * @description Allows read and write access to menu categories for a specific tenant to tenant admins and superadmins.
     * @path /tenants/{tenantId}/categories/{categoryId}
     * @allow (get, list): if isSignedIn() && (isTenantAdmin(tenantId) || isSuperAdmin())
     * @allow (create): if isSignedIn() && (isTenantAdmin(tenantId) || isSuperAdmin())
     * @allow (update, delete): if isSignedIn() && (isTenantAdmin(tenantId) || isSuperAdmin()) && resource != null;
     * @deny (get, list): if !isSignedIn() || (!isTenantAdmin(tenantId) && !isSuperAdmin())
     * @deny (create): if !isSignedIn() || (!isTenantAdmin(tenantId) && !isSuperAdmin())
     * @deny (update, delete): if !isSignedIn() || (!(isTenantAdmin(tenantId) || isSuperAdmin()) || resource == null)
     * @principle Enforces tenant-admin or superadmin access for category management.
     */
    match /tenants/{tenantId}/categories/{categoryId} {
      allow get, list: if isSignedIn() && (isTenantAdmin(tenantId) || isSuperAdmin());
      allow create: if isSignedIn() && (isTenantAdmin(tenantId) || isSuperAdmin());
      allow update, delete: if isSignedIn() && (isTenantAdmin(tenantId) || isSuperAdmin()) && resource != null;
    }

    /**
     * @description Allows read and write access to orders for a specific tenant to tenant admins and superadmins.
     *               Allows order creation with token verification.
     * @path /tenants/{tenantId}/orders/{orderId}
     * @allow (get, list): if isSignedIn() && (isTenantAdmin(tenantId) || isSuperAdmin())
     * @allow (create): if isSignedIn() && isValidOrder(tenantId);
     * @allow (update, delete): if isSignedIn() && (isTenantAdmin(tenantId) || isSuperAdmin()) && resource != null;
     * @deny (get, list): if !isSignedIn() || (!isTenantAdmin(tenantId) && !isSuperAdmin())
     * @deny (create): if !isSignedIn() || !isValidOrder(tenantId)
     * @deny (update, delete): if !isSignedIn() || (!(isTenantAdmin(tenantId) || isSuperAdmin()) || resource == null)
     * @principle Enforces tenant-admin or superadmin access for order management.
     * @principle Validates order creation with token verification.
     */
    match /tenants/{tenantId}/orders/{orderId} {
      allow get, list: if isSignedIn() && (isTenantAdmin(tenantId) || isSuperAdmin());
      allow create: if isSignedIn() && isValidOrder(tenantId);
      allow update, delete: if isSignedIn() && (isTenantAdmin(tenantId) || isSuperAdmin()) && resource != null;
    }

    /**
     * @description Allows read and write access to tables for a specific tenant to tenant admins and superadmins.
     * @path /tenants/{tenantId}/tables/{tableId}
     * @allow (get, list): if isSignedIn() && (isTenantAdmin(tenantId) || isSuperAdmin())
     * @allow (create): if isSignedIn() && (isTenantAdmin(tenantId) || isSuperAdmin())
     * @allow (update, delete): if isSignedIn() && (isTenantAdmin(tenantId) || isSuperAdmin()) && resource != null;
     * @deny (get, list): if !isSignedIn() || (!isTenantAdmin(tenantId) && !isSuperAdmin())
     * @deny (create): if !isSignedIn() || (!isTenantAdmin(tenantId) && !isSuperAdmin())
     * @deny (update, delete): if !isSignedIn() || (!(isTenantAdmin(tenantId) || isSuperAdmin()) || resource == null)
     * @principle Enforces tenant-admin or superadmin access for table management.
     */
    match /tenants/{tenantId}/tables/{tableId} {
      allow get, list: if isSignedIn() && (isTenantAdmin(tenantId) || isSuperAdmin());
      allow create: if isSignedIn() && (isTenantAdmin(tenantId) || isSuperAdmin());
      allow update, delete: if isSignedIn() && (isTenantAdmin(tenantId) || isSuperAdmin()) && resource != null;
    }

     /**
      * @description Allows read and write access to superadmin role assignments only to superadmins.
      * @path /roles_superadmin/{userId}
      * @allow get, list: if isSignedIn() && isSuperAdmin();
      * @allow create, update, delete: if isSignedIn() && isSuperAdmin();
      * @deny get, list: if !isSignedIn() || !isSuperAdmin();
      * @deny create, update, delete: if !isSignedIn() || !isSuperAdmin();
      * @principle Enforces superadmin-only access to superadmin role assignments.
      */
    match /roles_superadmin/{userId} {
      allow get, list: if isSignedIn() && isSuperAdmin();
      allow create, update, delete: if isSignedIn() && isSuperAdmin();
    }

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isSelfCreate(userId) {
        return request.auth.uid == userId;
    }

    function isSuperAdmin() {
      return exists(/databases/$(database)/documents/roles_superadmin/$(request.auth.uid));
    }

    function isTenantAdmin(tenantId) {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId
             && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin_kafe';
    }

    function isValidOrder(tenantId) {
      return request.resource.data.verificationToken == get(/databases/$(database)/documents/tenants/$(tenantId)).data.tokenHarian;
    }
  }
}