/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a role-based access control system with ownership checks for data managed within the AirCafe application.
 *
 * Data Structure:
 * - /tenants/{tenantId}: Stores tenant-specific data. Accessible to superadmins, and tenant admins (owners)
 * - /users/{userId}: Stores user profiles, with tenantId linking users to tenants. Owner-only access.
 * - /roles_superadmin/{userId}: Stores superadmin role assignments. Only accessible to superadmins.
 * - /tenants/{tenantId}/menus/{menuId}: Stores menu items for a specific tenant. Accessible to tenant admins (owners).
 * - /tenants/{tenantId}/categories/{categoryId}: Stores menu categories. Accessible to tenant admins (owners).
 * - /tenants/{tenantId}/orders/{orderId}: Stores order information. Accessible to tenant admins (owners).
 * - /tenants/{tenantId}/tables/{tableId}: Stores table data. Accessible to tenant admins (owners).
 *
 * Key Security Decisions:
 * - User listing is disallowed.
 * - Superadmin role is managed through the 'roles_superadmin' collection.
 * - All writes (create, update, delete) require explicit authorization checks.
 * - Data shape validation is minimal in this prototyping phase, focusing only on fields critical for authorization and relational integrity.
 *
 * Denormalization for Authorization:
 * - User documents contain a 'tenantId' field, enabling efficient tenant-based access control without additional reads.
 * - Superadmin status is checked directly via the 'roles_superadmin' collection, avoiding complex queries.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the current user is signed in.
     * @path N/A (Helper Function)
     * @allow N/A (Helper Function)
     * @deny N/A (Helper Function)
     * @principle Authentication: Ensures that only authenticated users can access the data.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the current user is the owner (identified by userId).
     * @path N/A (Helper Function)
     * @allow N/A (Helper Function)
     * @deny N/A (Helper Function)
     * @principle Ownership: Ensures that only the owner of the resource can modify it.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the current user is an existing owner (identified by userId) and that the document exists.
     * @path N/A (Helper Function)
     * @allow N/A (Helper Function)
     * @deny N/A (Helper Function)
     * @principle Ownership and Existence: Ensures that only the owner can modify existing documents.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }
    
    /**
     * @description Checks if the current user has the 'superadmin' role.
     * @path N/A (Helper Function)
     * @allow N/A (Helper Function)
     * @deny N/A (Helper Function)
     */
    function isSuperAdmin() {
      return exists(/databases/$(database)/documents/roles_superadmin/$(request.auth.uid));
    }

    /**
     * @description Rules for the /tenants collection.
     * @path /tenants/{tenantId}
     * @allow (get) Authenticated superadmin can get any tenant.
     * @allow (create) Authenticated superadmin can create tenant data.
     * @deny (get) Non-superadmin cannot get tenant data.
     * @deny (create) Non-superadmin cannot create tenant data.
     * @principle Role-based access control: Superadmins can manage tenants.
     */
    match /tenants/{tenantId} {
      allow get: if isSuperAdmin();
      allow list: if false;
      allow create: if isSuperAdmin();
      allow update: if isSuperAdmin();
      allow delete: if isSuperAdmin();
    }

    /**
     * @description Rules for the /users collection.
     * @path /users/{userId}
     * @allow (create) A user can create their own profile (self-registration).
     * @allow (get) A user can get their own profile.
     * @deny (update) A user cannot update someone else's profile.
     * @deny (delete) A user cannot delete someone else's profile.
     * @principle Owner-only access: Users can only manage their own profiles.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }
    
    /**
     * @description Rules for the /roles_superadmin collection.
     * @path /roles_superadmin/{userId}
     * @allow (get) Only superadmins can read superadmin role data.
     * @allow (create) Only superadmins can create superadmin role data.
     * @deny (update) No one can update superadmin role data (managed internally).
     * @deny (delete) No one can delete superadmin role data (managed internally).
     * @principle Role-based access control: Superadmins manage superadmin roles.
     */
    match /roles_superadmin/{userId} {
      allow get: if isSuperAdmin();
      allow list: if false;
      allow create: if isSuperAdmin();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rules for the /tenants/{tenantId}/menus collection.
     * @path /tenants/{tenantId}/menus/{menuId}
     * @allow (get) Tenant admins can read menu items.
     * @allow (create) Tenant admins can create menu items.
     * @deny (update) Non-tenant admins cannot update menu items.
     * @deny (delete) Non-tenant admins cannot delete menu items.
     * @principle Tenant-based access control: Tenant admins manage their menus.
     */
    match /tenants/{tenantId}/menus/{menuId} {
      allow get: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      allow list: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      allow create: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      allow update: if (resource != null) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      allow delete: if (resource != null) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
    }

    /**
     * @description Rules for the /tenants/{tenantId}/categories collection.
     * @path /tenants/{tenantId}/categories/{categoryId}
     * @allow (get) Tenant admins can read categories.
     * @allow (create) Tenant admins can create categories.
     * @deny (update) Non-tenant admins cannot update categories.
     * @deny (delete) Non-tenant admins cannot delete categories.
     * @principle Tenant-based access control: Tenant admins manage categories.
     */
    match /tenants/{tenantId}/categories/{categoryId} {
      allow get: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      allow list: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      allow create: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      allow update: if (resource != null) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      allow delete: if (resource != null) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
    }

    /**
     * @description Rules for the /tenants/{tenantId}/orders collection.
     * @path /tenants/{tenantId}/orders/{orderId}
     * @allow (get) Tenant admins can read orders.
     * @allow (create) Tenant admins can create orders.
     * @deny (update) Non-tenant admins cannot update orders.
     * @deny (delete) Non-tenant admins cannot delete orders.
     * @principle Tenant-based access control: Tenant admins manage orders.
     */
    match /tenants/{tenantId}/orders/{orderId} {
      allow get: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      allow list: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      allow create: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      allow update: if (resource != null) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      allow delete: if (resource != null) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
    }

    /**
     * @description Rules for the /tenants/{tenantId}/tables collection.
     * @path /tenants/{tenantId}/tables/{tableId}
     * @allow (get) Tenant admins can read tables.
     * @allow (create) Tenant admins can create tables.
     * @deny (update) Non-tenant admins cannot update tables.
     * @deny (delete) Non-tenant admins cannot delete tables.
     * @principle Tenant-based access control: Tenant admins manage tables.
     */
    match /tenants/{tenantId}/tables/{tableId} {
      allow get: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      allow list: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      allow create: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      allow update: if (resource != null) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
      allow delete: if (resource != null) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
    }
  }
}