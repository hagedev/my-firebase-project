/**
 * @fileoverview Firestore Security Rules for AirCafe application.
 *
 * Core Philosophy:
 * This ruleset enforces a hybrid security model. Superadmins are managed
 * via the `roles_superadmin` collection and have elevated privileges.
 * Tenant admins manage their own data (menus, categories, orders, tables)
 * within their respective tenant document trees.
 *
 * Data Structure:
 * - /tenants/{tenantId}: Tenant profiles.
 * - /users/{userId}: User profiles. Each user belongs to a tenant.
 * - /roles_superadmin/{userId}: Superadmin role assignments.
 * - /tenants/{tenantId}/menus/{menuId}: Menu items for a tenant.
 * - /tenants/{tenantId}/categories/{categoryId}: Menu categories for a tenant.
 * - /tenants/{tenantId}/orders/{orderId}: Orders placed at a tenant.
 * - /tenants/{tenantId}/tables/{tableId}: Tables for a tenant.
 *
 * Key Security Decisions:
 * - Superadmin role is determined by presence in `roles_superadmin` collection.
 * - Tenant admins can manage data *only* under their own tenant ID.
 * - User listing is disallowed.
 * - Data validation is relaxed for rapid prototyping, focusing on authorization.
 *
 * Denormalization for Authorization:
 * The ruleset relies on the `tenantId` field within documents to enforce tenant-level access control.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Authentication check.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user is a superadmin based on the roles_superadmin collection.
     * @path /roles_superadmin/{userId}
     * @allow if get(/databases/$(database)/documents/roles_superadmin/$(request.auth.uid)).data.role == 'superadmin';
     * @deny if request.auth == null;
     * @principle Role-based access control.
     */
    function isSuperAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_superadmin/$(request.auth.uid));
    }

    /**
     * @description Checks if the user is the owner of the document, based on the provided userId.
     * @path N/A
     * @allow if request.auth.uid == userId;
     * @deny if request.auth.uid != userId;
     * @principle Ownership-based access control.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is the existing owner of the document, based on the provided userId, and that the resource is not null.
     * @path N/A
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Grants or denies access to the roles_superadmin collection.
     * @path /roles_superadmin/{userId}
     * @allow (create) if request.auth.uid == userId && request.resource.data.userId == userId && request.resource.data.role == 'superadmin';
     * @allow (get) if isSuperAdmin() || isOwner(userId);
     * @allow (list) if false;
     * @allow (update) if false;
     * @allow (delete) if false;
     * @deny (create) if request.auth == null || request.resource.data.role != 'superadmin' || request.resource.data.userId != userId;
     * @principle Enforces superadmin role and restricts listing, updating, and deleting superadmin data.
     */
    match /roles_superadmin/{userId} {
        allow get: if isSuperAdmin() || isOwner(userId);
        allow list: if false;
        allow create: if isSuperAdmin(); // Only superadmins can assign other superadmins roles
        allow update: if false;
        allow delete: if false;
    }

    /**
     * @description Grants or denies access to the tenants collection.
     * @path /tenants/{tenantId}
     */
    match /tenants/{tenantId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSuperAdmin();
      allow update: if isSuperAdmin();
      allow delete: if isSuperAdmin();
    }

    /**
     * @description Grants or denies access to the users collection.
     * @path /users/{userId}
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isSuperAdmin();
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId) || isSuperAdmin();
    }

    /**
     * @description Grants or denies access to the menus collection.
     * @path /tenants/{tenantId}/menus/{menuId}
     */
    match /tenants/{tenantId}/menus/{menuId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn(); // TODO: add tenant admin check
      allow update: if isSignedIn(); // TODO: add tenant admin check
      allow delete: if isSignedIn(); // TODO: add tenant admin check
    }

    /**
     * @description Grants or denies access to the categories collection.
     * @path /tenants/{tenantId}/categories/{categoryId}
     */
    match /tenants/{tenantId}/categories/{categoryId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn(); // TODO: add tenant admin check
      allow update: if isSignedIn(); // TODO: add tenant admin check
      allow delete: if isSignedIn(); // TODO: add tenant admin check
    }

    /**
     * @description Grants or denies access to the orders collection.
     * @path /tenants/{tenantId}/orders/{orderId}
     */
    match /tenants/{tenantId}/orders/{orderId} {
      allow get: if true;
      allow list: if true;
      allow create: if true; // TODO: restrict order creation
      allow update: if isSignedIn(); // TODO: add tenant admin check
      allow delete: if false;
    }

    /**
     * @description Grants or denies access to the tables collection.
     * @path /tenants/{tenantId}/tables/{tableId}
     */
    match /tenants/{tenantId}/tables/{tableId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn(); // TODO: add tenant admin check
      allow update: if isSignedIn(); // TODO: add tenant admin check
      allow delete: if isSignedIn(); // TODO: add tenant admin check
    }
  }
}