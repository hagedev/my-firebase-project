rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to Tenant documents.
     * @path /tenants/{tenantId}
     * @allow (get, list): if true;
     * @allow (create, update, delete): if isSuperAdmin();
     * @deny (create, update, delete): if !isSuperAdmin();
     * @principle Superadmins can manage tenant profiles. Read access is public.
     */
    match /tenants/{tenantId} {
      allow get, list: if true;
      allow create, update, delete: if isSuperAdmin();
    }

    /**
     * @description Controls access to User documents.
     * @path /users/{userId}
     * @allow create: if isSelfCreation(userId);
     * @allow get: if isOwner(userId) || isSuperAdmin();
     * @allow update: if isOwner(userId) || isSuperAdmin();
     * @allow delete: if isOwner(userId) || isSuperAdmin();
     * @deny list: if true;
     * @principle Users can only manage their own profiles, superadmins can manage all. Listing is disabled.
     */
    match /users/{userId} {
      allow create: if isSelfCreation(userId);
      allow get: if isOwner(userId) || isSuperAdmin();
      allow list: if false;
      allow update: if isOwner(userId) || isSuperAdmin();
      allow delete: if isOwner(userId) || isSuperAdmin();
    }

    /**
     * @description Controls access to Menu documents within a tenant.
     * @path /tenants/{tenantId}/menus/{menuId}
     * @allow get, list: if true;
     * @allow create: if isTenantAdmin(tenantId);
     * @allow update: if isTenantAdmin(tenantId);
     * @allow delete: if isTenantAdmin(tenantId);
     * @principle Tenant admins can manage menus within their tenant.
     */
    match /tenants/{tenantId}/menus/{menuId} {
      allow get, list: if true;
      allow create: if isTenantAdmin(tenantId);
      allow update: if isTenantAdmin(tenantId);
      allow delete: if isTenantAdmin(tenantId);
    }

    /**
     * @description Controls access to Category documents within a tenant.
     * @path /tenants/{tenantId}/categories/{categoryId}
     * @allow get, list: if true;
     * @allow create: if isTenantAdmin(tenantId);
     * @allow update: if isTenantAdmin(tenantId);
     * @allow delete: if isTenantAdmin(tenantId);
     * @principle Tenant admins can manage categories within their tenant.
     */
    match /tenants/{tenantId}/categories/{categoryId} {
      allow get, list: if true;
      allow create: if isTenantAdmin(tenantId);
      allow update: if isTenantAdmin(tenantId);
      allow delete: if isTenantAdmin(tenantId);
    }

    /**
     * @description Controls access to Order documents within a tenant.
     * @path /tenants/{tenantId}/orders/{orderId}
     * @allow get, list: if isTenantAdmin(tenantId) || isSuperAdmin();
     * @allow create: if isValidOrder(tenantId);
     * @allow update: if isTenantAdmin(tenantId);
     * @allow delete: if isTenantAdmin(tenantId);
     * @principle Tenant admins can manage orders within their tenant. Orders require valid token.
     */
    match /tenants/{tenantId}/orders/{orderId} {
      allow get, list: if isTenantAdmin(tenantId) || isSuperAdmin();
      allow create: if isValidOrder(tenantId);
      allow update: if isTenantAdmin(tenantId);
      allow delete: if isTenantAdmin(tenantId);
    }

    /**
     * @description Controls access to Table documents within a tenant.
     * @path /tenants/{tenantId}/tables/{tableId}
     * @allow get, list: if isTenantAdmin(tenantId) || isSuperAdmin();
     * @allow create: if isTenantAdmin(tenantId);
     * @allow update: if isTenantAdmin(tenantId);
     * @allow delete: if isTenantAdmin(tenantId);
     * @principle Tenant admins can manage tables within their tenant.
     */
    match /tenants/{tenantId}/tables/{tableId} {
      allow get, list: if isTenantAdmin(tenantId) || isSuperAdmin();
      allow create: if isTenantAdmin(tenantId);
      allow update: if isTenantAdmin(tenantId);
      allow delete: if isTenantAdmin(tenantId);
    }

     /**
      * @description Controls access to SuperAdmin role documents.
      * @path /roles_superadmin/{userId}
      * @allow get, list: if isSuperAdmin();
      * @allow create: if isSuperAdmin();
      * @allow update: if false;
      * @allow delete: if isSuperAdmin();
      * @principle Only superadmins can manage superadmin roles.
      */
    match /roles_superadmin/{userId} {
        allow get, list: if isSuperAdmin();
        allow create: if isSuperAdmin();
        allow update: if false;
        allow delete: if isSuperAdmin();
    }

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isSelfCreation(userId) {
        return isSignedIn() && request.auth.uid == userId;
    }

    function isTenantAdmin(tenantId) {
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
      return isSignedIn() && userDoc.tenantId == tenantId && (userDoc.role == 'admin_kafe' || isSuperAdmin());
    }

    function isSuperAdmin() {
        return isSignedIn() && exists(/databases/$(database)/documents/roles_superadmin/$(request.auth.uid));
    }

    function isValidOrder(tenantId) {
      return isSignedIn() && request.resource.data.tenantId == tenantId && request.resource.data.verificationToken == get(/databases/$(database)/documents/tenants/$(tenantId)).data.tokenHarian;
    }

    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }
  }
}