/**
 * @file Firestore Security Rules for AirCafe Application
 *
 * @core_philosophy This ruleset enforces a strict owner-only model for most data,
 *                  with tenant-based access control for data related to specific cafes.
 *                  Super admin roles are supported to grant database-wide access.
 * @data_structure
 *   - /tenants/{tenantId}: Stores cafe tenant profiles.
 *   - /users/{userId}: Stores cafe admin user profiles. User ID matches Firebase Auth UID.
 *   - /roles_superadmin/{userId}: Stores super admin role information. Document ID is the user's UID.
 *   - /tenants/{tenantId}/menus/{menuId}: Stores menu items for a specific tenant.
 *   - /tenants/{tenantId}/categories/{categoryId}: Stores menu categories for a specific tenant.
 *   - /tenants/{tenantId}/orders/{orderId}: Stores orders placed at a specific tenant.
 *   - /tenants/{tenantId}/tables/{tableId}: Stores tables for a specific tenant.
 * @key_security_decisions
 *   - Users can only create their own profile.
 *   - Listing users is disallowed.
 *   - Tenant-owned data (menus, categories, orders, tables) is accessible only to
 *     users who belong to that tenant.
 *   - Super admins have full read and write access to all data.
 * @denormalization_for_authorization
 *   - User documents store the tenantId to allow easy validation of tenant-specific data access.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows super admins to perform any operation.
     */
    function isSuperAdmin() {
      return exists(/databases/$(database)/documents/roles_superadmin/$(request.auth.uid));
    }

    /**
     * @description Checks if the user is signed in.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the requested user ID matches the authenticated user's ID.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is the owner of an existing document.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the user is associated with the specified tenant ID.
     */
    function isTenantOwner(tenantId) {
        return isSignedIn() && exists(/databases/$(database)/documents/users/$(request.auth.uid)) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
    }

    /**
     * @description Tenant profile management.
     * @path /tenants/{tenantId}
     * @allow (read) Authenticated users can retrieve tenant profiles.
     * @deny (create) Non-authenticated users cannot create tenant profiles.
     * @principle Enforces tenant-level access control and prevents unauthorized tenant creation.
     */
    match /tenants/{tenantId} {
      allow get: if true;
      allow list: if false;
      allow create: if false;
      allow update: if isSuperAdmin();
      allow delete: if isSuperAdmin();
    }

    /**
     * @description User profile management.
     * @path /users/{userId}
     * @allow (create) Users can create their own profile with a matching user ID.
     * @deny (update) Users cannot update profiles other than their own.
     * @principle Enforces user-ownership for profile data and prevents unauthorized modifications.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isSuperAdmin();
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId) || isSuperAdmin();
      allow delete: if isSuperAdmin();
    }

    /**
     * @description Super admin role management.
     * @path /roles_superadmin/{userId}
     * @allow (read, write) Only super admins can manage the super admin roles.
     * @deny (read, write) Regular users cannot access the super admin roles.
     * @principle Restricts super admin role management to existing super admins.
     */
    match /roles_superadmin/{userId} {
      allow get: if isSuperAdmin();
      allow list: if isSuperAdmin();
      allow create: if isSuperAdmin();
      allow update: if isSuperAdmin();
      allow delete: if isSuperAdmin();
    }

    /**
     * @description Menu item management for tenants.
     * @path /tenants/{tenantId}/menus/{menuId}
     * @allow (read) Authenticated users can retrieve menu items if they are associated with the tenant.
     * @deny (create) Non-authenticated users cannot create menu items.
     * @principle Enforces tenant-level access control for menu items.
     */
    match /tenants/{tenantId}/menus/{menuId} {
      allow get: if isTenantOwner(tenantId) || isSuperAdmin();
      allow list: if isTenantOwner(tenantId) || isSuperAdmin();
      allow create: if isTenantOwner(tenantId) || isSuperAdmin();
      allow update: if isTenantOwner(tenantId) || isSuperAdmin();
      allow delete: if isTenantOwner(tenantId) || isSuperAdmin();
    }

    /**
     * @description Menu category management for tenants.
     * @path /tenants/{tenantId}/categories/{categoryId}
     * @allow (read) Authenticated users can retrieve categories if they are associated with the tenant.
     * @deny (create) Non-authenticated users cannot create categories.
     * @principle Enforces tenant-level access control for menu categories.
     */
    match /tenants/{tenantId}/categories/{categoryId} {
      allow get: if isTenantOwner(tenantId) || isSuperAdmin();
      allow list: if isTenantOwner(tenantId) || isSuperAdmin();
      allow create: if isTenantOwner(tenantId) || isSuperAdmin();
      allow update: if isTenantOwner(tenantId) || isSuperAdmin();
      allow delete: if isTenantOwner(tenantId) || isSuperAdmin();
    }

    /**
     * @description Order management for tenants.
     * @path /tenants/{tenantId}/orders/{orderId}
     * @allow (read) Authenticated users can retrieve orders if they are associated with the tenant.
     * @deny (create) Non-authenticated users cannot create orders.
     * @principle Enforces tenant-level access control for orders.
     */
    match /tenants/{tenantId}/orders/{orderId} {
      allow get: if isTenantOwner(tenantId) || isSuperAdmin();
      allow list: if isTenantOwner(tenantId) || isSuperAdmin();
      allow create: if true;
      allow update: if isTenantOwner(tenantId) || isSuperAdmin();
      allow delete: if isTenantOwner(tenantId) || isSuperAdmin();
    }

    /**
     * @description Table management for tenants.
     * @path /tenants/{tenantId}/tables/{tableId}
     * @allow (read) Authenticated users can retrieve tables if they are associated with the tenant.
     * @deny (create) Non-authenticated users cannot create tables.
     * @principle Enforces tenant-level access control for tables.
     */
    match /tenants/{tenantId}/tables/{tableId} {
      allow get: if isTenantOwner(tenantId) || isSuperAdmin();
      allow list: if isTenantOwner(tenantId) || isSuperAdmin();
      allow create: if isTenantOwner(tenantId) || isSuperAdmin();
      allow update: if isTenantOwner(tenantId) || isSuperAdmin();
      allow delete: if isTenantOwner(tenantId) || isSuperAdmin();
    }
  }
}