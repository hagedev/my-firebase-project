rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Manages Tenant documents. Superadmins can CRUD, cafe admins can update their own tenant.
     * @path /tenants/{tenantId}
     * @allow (create) if isSignedIn() && isSuperAdmin()
     * @allow (get) if isSignedIn() && isSuperAdmin()
     * @allow (update) if isSignedIn() && (isSuperAdmin() || isTenantAdmin(tenantId))
     * @allow (delete) if isSignedIn() && isSuperAdmin()
     * @deny (create) if !isSignedIn() || !isSuperAdmin()
     * @deny (get) if !isSignedIn() || !isSuperAdmin()
     * @deny (update) if !isSignedIn() || (!isSuperAdmin() && !isTenantAdmin(tenantId))
     * @deny (delete) if !isSignedIn() || !isSuperAdmin()
     * @principle Enforces role-based access control: superadmins have full control, cafe admins can only update their own tenant.
     */
    match /tenants/{tenantId} {
      allow get: if isSignedIn() && isSuperAdmin();
      allow list: if false;
      allow create: if isSignedIn() && isSuperAdmin();
      allow update: if isSignedIn() && (isSuperAdmin() || (isSignedIn() && isTenantAdmin(tenantId)));
      allow delete: if isSignedIn() && isSuperAdmin();
    }

    /**
     * @description Manages User documents. Only superadmins can CRUD users.
     * @path /users/{userId}
     * @allow (create) if isSignedIn() && isSuperAdmin()
     * @allow (get) if isSignedIn() && isSuperAdmin()
     * @allow (update) if isSignedIn() && isSuperAdmin()
     * @allow (delete) if isSignedIn() && isSuperAdmin()
     * @deny (create) if !isSignedIn() || !isSuperAdmin()
     * @deny (get) if !isSignedIn() || !isSuperAdmin()
     * @deny (update) if !isSignedIn() || !isSuperAdmin()
     * @deny (delete) if !isSignedIn() || !isSuperAdmin()
     * @principle Enforces role-based access control: only superadmins can manage users.
     */
    match /users/{userId} {
      allow get: if isSignedIn() && isSuperAdmin();
      allow list: if false;
      allow create: if isSignedIn() && isSuperAdmin();
      allow update: if isSignedIn() && isSuperAdmin();
      allow delete: if isSignedIn() && isSuperAdmin();
    }

    /**
     * @description Manages Menu documents within a tenant. Cafe admins can CRUD menus in their tenant.
     * @path /tenants/{tenantId}/menus/{menuId}
     * @allow (create) if isSignedIn() && isTenantAdmin(tenantId)
     * @allow (get) if isSignedIn() && isTenantAdmin(tenantId)
     * @allow (update) if isSignedIn() && isTenantAdmin(tenantId)
     * @allow (delete) if isSignedIn() && isTenantAdmin(tenantId)
     * @deny (create) if !isSignedIn() || !isTenantAdmin(tenantId)
     * @deny (get) if !isSignedIn() || !isTenantAdmin(tenantId)
     * @deny (update) if !isSignedIn() || !isTenantAdmin(tenantId)
     * @deny (delete) if !isSignedIn() || !isTenantAdmin(tenantId)
     * @principle Enforces tenant-based access control: cafe admins can only manage menus in their own tenant.
     */
    match /tenants/{tenantId}/menus/{menuId} {
      allow get: if isSignedIn() && isTenantAdmin(tenantId);
      allow list: if isSignedIn() && isTenantAdmin(tenantId);
      allow create: if isSignedIn() && isTenantAdmin(tenantId);
      allow update: if isSignedIn() && isTenantAdmin(tenantId);
      allow delete: if isSignedIn() && isTenantAdmin(tenantId);
    }

    /**
     * @description Manages Category documents within a tenant. Cafe admins can CRUD categories in their tenant.
     * @path /tenants/{tenantId}/categories/{categoryId}
     * @allow (create) if isSignedIn() && isTenantAdmin(tenantId)
     * @allow (get) if isSignedIn() && isTenantAdmin(tenantId)
     * @allow (update) if isSignedIn() && isTenantAdmin(tenantId)
     * @allow (delete) if isSignedIn() && isTenantAdmin(tenantId)
     * @deny (create) if !isSignedIn() || !isTenantAdmin(tenantId)
     * @deny (get) if !isSignedIn() || !isTenantAdmin(tenantId)
     * @deny (update) if !isSignedIn() || !isTenantAdmin(tenantId)
     * @deny (delete) if !isSignedIn() || !isTenantAdmin(tenantId)
     * @principle Enforces tenant-based access control: cafe admins can only manage categories in their own tenant.
     */
    match /tenants/{tenantId}/categories/{categoryId} {
      allow get: if isSignedIn() && isTenantAdmin(tenantId);
      allow list: if isSignedIn() && isTenantAdmin(tenantId);
      allow create: if isSignedIn() && isTenantAdmin(tenantId);
      allow update: if isSignedIn() && isTenantAdmin(tenantId);
      allow delete: if isSignedIn() && isTenantAdmin(tenantId);
    }

    /**
     * @description Manages Order documents within a tenant. Cafe admins can CRUD orders in their tenant. Anonymous users can create orders with token verification.
     * @path /tenants/{tenantId}/orders/{orderId}
     * @allow (create) if request.resource.data.verificationToken == get(/databases/$(database)/documents/tenants/$(tenantId)).data.tokenHarian
     * @allow (get) if isSignedIn() && isTenantAdmin(tenantId)
     * @allow (update) if isSignedIn() && isTenantAdmin(tenantId)
     * @allow (delete) if isSignedIn() && isTenantAdmin(tenantId)
     * @deny (get) if !isSignedIn() || !isTenantAdmin(tenantId)
     * @deny (update) if !isSignedIn() || !isTenantAdmin(tenantId)
     * @deny (delete) if !isSignedIn() || !isTenantAdmin(tenantId)
     * @principle Enforces tenant-based access control and allows anonymous order creation with token verification.
     */
    match /tenants/{tenantId}/orders/{orderId} {
      allow get: if isSignedIn() && isTenantAdmin(tenantId);
      allow list: if isSignedIn() && isTenantAdmin(tenantId);
      allow create: if request.resource.data.verificationToken == get(/databases/$(database)/documents/tenants/$(tenantId)).data.tokenHarian;
      allow update: if isSignedIn() && isTenantAdmin(tenantId);
      allow delete: if isSignedIn() && isTenantAdmin(tenantId);
    }

    /**
     * @description Manages Table documents within a tenant. Cafe admins can read and update tables in their tenant.
     * @path /tenants/{tenantId}/tables/{tableId}
     * @allow (get) if isSignedIn() && isTenantAdmin(tenantId)
     * @allow (update) if isSignedIn() && isTenantAdmin(tenantId)
     * @deny (get) if !isSignedIn() || !isTenantAdmin(tenantId)
     * @deny (update) if !isSignedIn() || !isTenantAdmin(tenantId)
     * @principle Enforces tenant-based access control: cafe admins can only manage tables in their own tenant.
     */
    match /tenants/{tenantId}/tables/{tableId} {
      allow get: if isSignedIn() && isTenantAdmin(tenantId);
      allow list: if isSignedIn() && isTenantAdmin(tenantId);
      allow create: if false;
      allow update: if isSignedIn() && isTenantAdmin(tenantId);
      allow delete: if false;
    }
    
    /**
     * @description Indicates superadmin privileges. Existence of a document for a user ID implies superadmin privileges.
     * @path /roles_superadmin/{userId}
     */
    match /roles_superadmin/{userId} {
      allow get: if isSignedIn() && isSuperAdmin();
      allow list: if false;
      allow create: if isSignedIn() && isSuperAdmin();
      allow update: if false;
      allow delete: if isSignedIn() && isSuperAdmin();
    }

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isSuperAdmin() {
        return exists(/databases/$(database)/documents/roles_superadmin/$(request.auth.uid));
    }

    function isTenantAdmin(tenantId) {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
    }
  }
}